
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Speechain Toolkit">
      
      
      
      
        <link rel="prev" href="../abs/">
      
      
        <link rel="next" href="../../infer_func/beam_search/">
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.46">
    
    
      
        <title>speech_text - Speechain</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../css/code_select.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dataset.speech_text" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Speechain" class="md-header__button md-logo" aria-label="Speechain" data-md-component="logo">
      
  <img src="../../../img/speechain.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Speechain
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              speech_text
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/bagustris/speechain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Speechain" class="md-nav__button md-logo" aria-label="Speechain" data-md-component="logo">
      
  <img src="../../../img/speechain.png" alt="logo">

    </a>
    Speechain
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bagustris/speechain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../datasets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Datasets
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ASR
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TTS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    criterion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            criterion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/accuracy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    accuracy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/att_guid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    att_guid
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/bce_logits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bce_logits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/cross_entropy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cross_entropy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/ctc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/error_rate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    error_rate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/fbeta_score/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fbeta_score
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/least_error/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    least_error
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../criterion/perplexity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    perplexity
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    dataset
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            dataset
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    speech_text
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    speech_text
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dataset.speech_text" class="md-nav__link">
    <span class="md-ellipsis">
      speech_text
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataset.speech_text.RandomSpkFeatDataset" class="md-nav__link">
    <span class="md-ellipsis">
      RandomSpkFeatDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RandomSpkFeatDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.RandomSpkFeatDataset.extract_main_data_fn" class="md-nav__link">
    <span class="md-ellipsis">
      extract_main_data_fn
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset" class="md-nav__link">
    <span class="md-ellipsis">
      SpeechTextDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpeechTextDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.collate_main_data_fn" class="md-nav__link">
    <span class="md-ellipsis">
      collate_main_data_fn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.data_len_register_fn" class="md-nav__link">
    <span class="md-ellipsis">
      data_len_register_fn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.dataset_init_fn" class="md-nav__link">
    <span class="md-ellipsis">
      dataset_init_fn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.extract_main_data_fn" class="md-nav__link">
    <span class="md-ellipsis">
      extract_main_data_fn
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    infer_func
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            infer_func
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infer_func/beam_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    beam_search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infer_func/ctc_decoding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctc_decoding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infer_func/tts_decoding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tts_decoding
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    iterator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            iterator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../iterator/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../iterator/block/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    block
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    model
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model/ar_asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_asr
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model/ar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_tts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model/lm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model/nar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nar_tts
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    module
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            module
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_2" >
        
          
          <label class="md-nav__link" for="__nav_5_6_2" id="__nav_5_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    augment
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_2">
            <span class="md-nav__icon md-icon"></span>
            augment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/augment/specaug/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    specaug
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_3" >
        
          
          <label class="md-nav__link" for="__nav_5_6_3" id="__nav_5_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    conformer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_3">
            <span class="md-nav__icon md-icon"></span>
            conformer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/conformer/attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/conformer/encoder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    encoder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/conformer/pos_enc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pos_enc
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_4" >
        
          
          <label class="md-nav__link" for="__nav_5_6_4" id="__nav_5_6_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    decoder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_4">
            <span class="md-nav__icon md-icon"></span>
            decoder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/decoder/ar_asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_asr
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/decoder/ar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_tts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/decoder/nar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nar_tts
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_5" >
        
          
          <label class="md-nav__link" for="__nav_5_6_5" id="__nav_5_6_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    encoder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_5">
            <span class="md-nav__icon md-icon"></span>
            encoder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/encoder/asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asr
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/encoder/tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tts
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6_6" id="__nav_5_6_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    frontend
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_6">
            <span class="md-nav__icon md-icon"></span>
            frontend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/frontend/delta_feat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    delta_feat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/frontend/linear2mel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linear2mel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/frontend/speech2linear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech2linear
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/frontend/speech2mel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech2mel
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_7" >
        
          
          <label class="md-nav__link" for="__nav_5_6_7" id="__nav_5_6_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    norm
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_7">
            <span class="md-nav__icon md-icon"></span>
            norm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/norm/feat_norm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    feat_norm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_8" >
        
          
          <label class="md-nav__link" for="__nav_5_6_8" id="__nav_5_6_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    postnet
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_8">
            <span class="md-nav__icon md-icon"></span>
            postnet
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/postnet/conv1d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conv1d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/postnet/token/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    token
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_9" >
        
          
          <label class="md-nav__link" for="__nav_5_6_9" id="__nav_5_6_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    prenet
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_9">
            <span class="md-nav__icon md-icon"></span>
            prenet
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/prenet/conv1d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conv1d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/prenet/conv2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conv2d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/prenet/embed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    embed
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/prenet/linear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linear
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/prenet/spk_embed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    spk_embed
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/prenet/var_pred/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    var_pred
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_10" >
        
          
          <label class="md-nav__link" for="__nav_5_6_10" id="__nav_5_6_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    standalone
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_10">
            <span class="md-nav__icon md-icon"></span>
            standalone
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/standalone/lm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_11" >
        
          
          <label class="md-nav__link" for="__nav_5_6_11" id="__nav_5_6_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    transformer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_11">
            <span class="md-nav__icon md-icon"></span>
            transformer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/transformer/attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/transformer/decoder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    decoder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/transformer/encoder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    encoder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/transformer/feed_forward/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    feed_forward
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module/transformer/pos_enc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pos_enc
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    monitor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    optim_sche
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            optim_sche
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optim_sche/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optim_sche/exp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optim_sche/noam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    noam
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    pyscripts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            pyscripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pyscripts/empty_file_checker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    empty_file_checker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pyscripts/folder_summarizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    folder_summarizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pyscripts/model_para_renamer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    model_para_renamer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pyscripts/phn_duaration_visualizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    phn_duaration_visualizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pyscripts/text_dist_visualizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    text_dist_visualizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pyscripts/wavlen_dist_visualizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wavlen_dist_visualizer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../runner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    runner
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snapshooter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    snapshooter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_12" >
        
          
          <label class="md-nav__link" for="__nav_5_12" id="__nav_5_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    tokenizer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_12">
            <span class="md-nav__icon md-icon"></span>
            tokenizer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenizer/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenizer/char/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    char
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenizer/g2p/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    g2p
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenizer/sp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sp
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_13" >
        
          
          <label class="md-nav__link" for="__nav_5_13" id="__nav_5_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    utilbox
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_13">
            <span class="md-nav__icon md-icon"></span>
            utilbox
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/data_loading_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data_loading_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/data_saving_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data_saving_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/dump_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dump_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/eval_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eval_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/feat_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    feat_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/import_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    import_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/log_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    log_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/md_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    md_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/regex_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    regex_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/sb_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sb_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/spk_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    spk_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/tensor_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tensor_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/text_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    text_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/train_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    train_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/type_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    type_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilbox/yaml_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    yaml_util
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dataset.speech_text" class="md-nav__link">
    <span class="md-ellipsis">
      speech_text
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataset.speech_text.RandomSpkFeatDataset" class="md-nav__link">
    <span class="md-ellipsis">
      RandomSpkFeatDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RandomSpkFeatDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.RandomSpkFeatDataset.extract_main_data_fn" class="md-nav__link">
    <span class="md-ellipsis">
      extract_main_data_fn
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset" class="md-nav__link">
    <span class="md-ellipsis">
      SpeechTextDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpeechTextDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.collate_main_data_fn" class="md-nav__link">
    <span class="md-ellipsis">
      collate_main_data_fn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.data_len_register_fn" class="md-nav__link">
    <span class="md-ellipsis">
      data_len_register_fn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.dataset_init_fn" class="md-nav__link">
    <span class="md-ellipsis">
      dataset_init_fn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset.speech_text.SpeechTextDataset.extract_main_data_fn" class="md-nav__link">
    <span class="md-ellipsis">
      extract_main_data_fn
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>speech_text</h1>

<div class="doc doc-object doc-module">



<a id="dataset.speech_text"></a>
    <div class="doc doc-contents first">

        <p>Author: Heli Qi
Affiliation: NAIST
Date: 2022.07</p>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="dataset.speech_text.RandomSpkFeatDataset" class="doc doc-heading">
            <code>RandomSpkFeatDataset</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="dataset.speech_text.SpeechTextDataset" href="#dataset.speech_text.SpeechTextDataset">SpeechTextDataset</a></code></p>


        






              <details class="quote">
                <summary>Source code in <code>speechain/dataset/speech_text.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RandomSpkFeatDataset</span><span class="p">(</span><span class="n">SpeechTextDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">dataset_init_fn</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spk_feat</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_aver_feat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mixup_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">super_conf</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">RandomSpkFeatDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dataset_init_fn</span><span class="p">(</span><span class="o">**</span><span class="n">super_conf</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">spk_feat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;spk_feat cannot be None. Please specify it in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">mixup_number</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mixup_number</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;mixup_number must be a positive integer, but got </span><span class="si">{</span><span class="n">mixup_number</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mixup_number</span> <span class="o">=</span> <span class="n">mixup_number</span>

        <span class="c1"># List[str] or str -&gt; List[str]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spk_feat</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
            <span class="n">spk_feat</span> <span class="o">=</span> <span class="p">[</span><span class="n">spk_feat</span><span class="p">]</span>
        <span class="n">metadata_dir</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">s_f</span><span class="p">)</span> <span class="k">for</span> <span class="n">s_f</span> <span class="ow">in</span> <span class="n">spk_feat</span><span class="p">]</span>
        <span class="n">spk_emb_model</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">s_f</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s_f</span> <span class="ow">in</span> <span class="n">spk_feat</span>
        <span class="p">]</span>

        <span class="c1"># register the list of available speaker IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx2spk</span> <span class="o">=</span> <span class="n">load_idx2data_file</span><span class="p">(</span>
            <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m_d</span><span class="p">,</span> <span class="s2">&quot;idx2spk&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">m_d</span> <span class="ow">in</span> <span class="n">metadata_dir</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk_ids_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx2spk</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spk_ids_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk2freq</span> <span class="o">=</span> <span class="p">{</span><span class="n">spk_id</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">spk_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_ids_list</span><span class="p">}</span>

        <span class="c1"># speaker embedding file reading, List[str] -&gt; Dict[str, str]</span>
        <span class="n">idx2spk_feat</span> <span class="o">=</span> <span class="n">load_idx2data_file</span><span class="p">(</span><span class="n">spk_feat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk2spk_feat</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">spk_id</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">spk_feat_id</span><span class="p">:</span> <span class="n">idx2spk_feat</span><span class="p">[</span><span class="n">spk_feat_id</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">spk_feat_id</span> <span class="ow">in</span> <span class="n">idx2spk_feat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx2spk</span><span class="p">[</span><span class="n">spk_feat_id</span><span class="p">]</span> <span class="o">==</span> <span class="n">spk_id</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">spk_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_ids_list</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">use_aver_feat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spk2aver_spk_feat</span> <span class="o">=</span> <span class="n">load_idx2data_file</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m_d</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;spk2aver_</span><span class="si">{</span><span class="n">s_e_m</span><span class="si">}</span><span class="s2">_spk_feat&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m_d</span><span class="p">,</span> <span class="n">s_e_m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">metadata_dir</span><span class="p">,</span> <span class="n">spk_emb_model</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_main_data_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hook function randomly pick up a speaker embedding feature from the given spk_feat file as the reference.</span>
<span class="sd">        The randomness is controlled by the `seed` you give in the exp_cfg.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;spk_ids&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Please don&#39;t give spk_ids to main_data of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This Dataset is used to evaluate open-set multi-speaker TTS that uses external speaker embedding.&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Please don&#39;t give spk_feat to main_data of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Your spk_feat should be given outside the main_data.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># process &#39;feat&#39; and &#39;text&#39; by the parent class</span>
        <span class="n">main_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RandomSpkFeatDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">extract_main_data_fn</span><span class="p">(</span><span class="n">main_data</span><span class="p">)</span>
        <span class="c1"># None means empty batch received from the parent class</span>
        <span class="k">if</span> <span class="n">main_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">main_data</span>

        <span class="n">chosen_spk_feat_ids</span><span class="p">,</span> <span class="n">chosen_spk_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_spk_feat_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixup_number</span><span class="p">:</span>
            <span class="n">random_spk_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk2freq</span> <span class="o">=</span> <span class="n">get_min_indices_by_freq</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spk2freq</span><span class="p">,</span>
                <span class="n">freq_weights</span><span class="o">=</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">random_spk_id</span> <span class="o">=</span> <span class="n">random_spk_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># randomly pick up a speaker embedding feature vector</span>
            <span class="n">spk_feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk2spk_feat</span><span class="p">[</span><span class="n">random_spk_id</span><span class="p">]</span>
            <span class="n">spk_feat_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spk_feat</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">random_spk_feat_id</span> <span class="o">=</span> <span class="n">spk_feat_id_list</span><span class="p">[</span>
                <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spk_feat_id_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;spk2aver_spk_feat&quot;</span><span class="p">):</span>
                <span class="n">spk_feat</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
                    <span class="n">spk_feat</span><span class="p">[</span><span class="n">random_spk_feat_id</span><span class="p">],</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># randomly pick up a useless spk_feat_id for the same randomness results</span>
                <span class="n">random_spk_feat_id</span> <span class="o">=</span> <span class="s2">&quot;aver_spk_feat&quot;</span>
                <span class="n">spk_feat</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spk2aver_spk_feat</span><span class="p">[</span><span class="n">random_spk_id</span><span class="p">],</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spk_feat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">spk_feat</span>

            <span class="n">chosen_spk_feat_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_spk_feat_id</span><span class="p">)</span>
            <span class="n">chosen_spk_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_spk_id</span><span class="p">)</span>

        <span class="c1"># take the average of the chose speaker embedding features</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixup_number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixup_number</span>
            <span class="c1"># sort all the IDs of spk_feat and spk to make sure the naming uniqueness</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">chosen_spk_feat_ids</span><span class="p">))</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">chosen_spk_ids</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_spk_feat_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_spk_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">main_data</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="dataset.speech_text.RandomSpkFeatDataset.extract_main_data_fn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_main_data_fn</span><span class="p">(</span><span class="n">main_data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This hook function randomly pick up a speaker embedding feature from the given spk_feat file as the reference.
The randomness is controlled by the <code>seed</code> you give in the exp_cfg.</p>

            <details class="quote">
              <summary>Source code in <code>speechain/dataset/speech_text.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_main_data_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This hook function randomly pick up a speaker embedding feature from the given spk_feat file as the reference.</span>
<span class="sd">    The randomness is controlled by the `seed` you give in the exp_cfg.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;spk_ids&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Please don&#39;t give spk_ids to main_data of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;This Dataset is used to evaluate open-set multi-speaker TTS that uses external speaker embedding.&quot;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Please don&#39;t give spk_feat to main_data of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Your spk_feat should be given outside the main_data.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># process &#39;feat&#39; and &#39;text&#39; by the parent class</span>
    <span class="n">main_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RandomSpkFeatDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">extract_main_data_fn</span><span class="p">(</span><span class="n">main_data</span><span class="p">)</span>
    <span class="c1"># None means empty batch received from the parent class</span>
    <span class="k">if</span> <span class="n">main_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">main_data</span>

    <span class="n">chosen_spk_feat_ids</span><span class="p">,</span> <span class="n">chosen_spk_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_spk_feat_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixup_number</span><span class="p">:</span>
        <span class="n">random_spk_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk2freq</span> <span class="o">=</span> <span class="n">get_min_indices_by_freq</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spk2freq</span><span class="p">,</span>
            <span class="n">freq_weights</span><span class="o">=</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">random_spk_id</span> <span class="o">=</span> <span class="n">random_spk_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># randomly pick up a speaker embedding feature vector</span>
        <span class="n">spk_feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk2spk_feat</span><span class="p">[</span><span class="n">random_spk_id</span><span class="p">]</span>
        <span class="n">spk_feat_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spk_feat</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">random_spk_feat_id</span> <span class="o">=</span> <span class="n">spk_feat_id_list</span><span class="p">[</span>
            <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spk_feat_id_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;spk2aver_spk_feat&quot;</span><span class="p">):</span>
            <span class="n">spk_feat</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
                <span class="n">spk_feat</span><span class="p">[</span><span class="n">random_spk_feat_id</span><span class="p">],</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># randomly pick up a useless spk_feat_id for the same randomness results</span>
            <span class="n">random_spk_feat_id</span> <span class="o">=</span> <span class="s2">&quot;aver_spk_feat&quot;</span>
            <span class="n">spk_feat</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spk2aver_spk_feat</span><span class="p">[</span><span class="n">random_spk_id</span><span class="p">],</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spk_feat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">spk_feat</span>

        <span class="n">chosen_spk_feat_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_spk_feat_id</span><span class="p">)</span>
        <span class="n">chosen_spk_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_spk_id</span><span class="p">)</span>

    <span class="c1"># take the average of the chose speaker embedding features</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixup_number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixup_number</span>
        <span class="c1"># sort all the IDs of spk_feat and spk to make sure the naming uniqueness</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">chosen_spk_feat_ids</span><span class="p">))</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">chosen_spk_ids</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_spk_feat_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_spk_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">main_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="dataset.speech_text.SpeechTextDataset" class="doc doc-heading">
            <code>SpeechTextDataset</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="speechain.dataset.abs.Dataset">Dataset</span></code></p>


        <p>This Dataset subclass is mainly used by ASR and TTS models.
In this subclass, each data instance is made up of an utterance and a sentence as well as the speaker information
(speaker ID + speaker embedding feature).</p>






              <details class="quote">
                <summary>Source code in <code>speechain/dataset/speech_text.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SpeechTextDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Dataset subclass is mainly used by ASR and TTS models.</span>
<span class="sd">    In this subclass, each data instance is made up of an utterance and a sentence as well as the speaker information</span>
<span class="sd">    (speaker ID + speaker embedding feature).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">dataset_init_fn</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">use_g2p</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">unk_mask_prob</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">use_speed_perturb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">,</span>
        <span class="n">perturb_range</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span>
        <span class="n">pitch_conf</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dataset initialization function.</span>

<span class="sd">        Args:</span>
<span class="sd">            use_g2p (bool, optional): Whether to process the raw string by G2P. We don&#39;t</span>
<span class="sd">                recommend you to turn it on because on-the-fly transformer from string to</span>
<span class="sd">                phoneme list consumes a lot of CPU resources. Defaults to False.</span>

<span class="sd">            unk_mask_prob (float, optional): Probability of masking tokens as unknown.</span>
<span class="sd">                Defaults to 0.0.</span>
<span class="sd">            use_speed_perturb (bool, optional): Whether to perturb the speed of the</span>
<span class="sd">                waveforms. Defaults to False.</span>
<span class="sd">            sample_rate (int, optional): Audio sampling rate in Hz. Defaults to 16000.</span>
<span class="sd">            perturb_range (List[float], optional): Range of speed perturbation factors.</span>
<span class="sd">                Defaults to [0.9, 1.0, 1.1].</span>

<span class="sd">            pitch_conf (Dict, optional): The configuration given to convert_wav_to_pitch()</span>
<span class="sd">                for pitch extraction. If not given, pitch extraction will not be done</span>
<span class="sd">                on-the-fly. Defaults to None.</span>

<span class="sd">        Note:</span>
<span class="sd">            Phoneme related: use_g2p</span>
<span class="sd">            Waveform related: unk_mask_prob, use_speed_perturb, sample_rate, perturb_range</span>
<span class="sd">            Pitch related: pitch_conf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># register sampling rate for later check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The waveform sampling rate of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is set to </span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;All the extracted waveforms will be downsampled into </span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2"> if needed. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Please make sure that </span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2"> is the same with your model! &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;If this is not your target sampling rate, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;please change it by the key &#39;sample_rate&#39; in the item &#39;dataset_conf&#39; under &#39;data_cfg&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;If you want to train Language Models or synthesize speech by text, you can ignore this warning.&quot;</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">unk_mask_prob</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;unk_mask_prob should be a float number in [0, 1], but got </span><span class="si">{</span><span class="n">unk_mask_prob</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span> <span class="o">=</span> <span class="n">unk_mask_prob</span>

        <span class="c1"># phoneme extraction</span>
        <span class="k">if</span> <span class="n">use_g2p</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span> <span class="o">=</span> <span class="n">G2p</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">use_speed_perturb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perturb_range</span> <span class="o">=</span> <span class="n">perturb_range</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed_resampler_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torchaudio</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resample</span><span class="p">(</span>
                    <span class="n">orig_freq</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">new_freq</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">perturb_range</span>
            <span class="p">]</span>

        <span class="c1"># pitch extraction</span>
        <span class="k">if</span> <span class="n">pitch_conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;sr&quot;</span> <span class="ow">in</span> <span class="n">pitch_conf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">pitch_conf</span><span class="p">[</span><span class="s2">&quot;sr&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The sampling rate in your given &#39;pitch_conf&#39; (</span><span class="si">{</span><span class="n">pitch_conf</span><span class="p">[</span><span class="s1">&#39;sr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) is different from your &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;given sample_rate (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">)!&quot;</span>
                <span class="p">)</span>
            <span class="n">pitch_conf</span><span class="p">[</span><span class="s2">&quot;sr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pitch_extract_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">convert_wav_to_pitch</span><span class="p">,</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">pitch_conf</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">data_len_register_fn</span><span class="p">(</span>
        <span class="n">main_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            If &#39;text&#39; is given in main_data, return the number of characters in each sentence.</span>
<span class="sd">            Otherwise, return None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">collate_main_data_fn</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">batch_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="ow">or</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The utterances used for training ASR and TTS models may have different lengths, so we need to do the</span>
<span class="sd">        padding operations to make them equal in length.</span>

<span class="sd">        The loaded speech feature vectors will be arranged into a single matrix with 0 padding at the end of short</span>
<span class="sd">        vectors. Text data remains unprocessed strings and the tokenization will be done later in the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_dict (Dict[str, List]): The keys of the input `batch_dict` dictionary should be one of the following:</span>
<span class="sd">                1. `feat`: a List of 2d `torch.Tensor` with different lengths.</span>
<span class="sd">                2. `pitch`: a List of 1d `torch.Tensor` with different lengths.</span>
<span class="sd">                3. `text`: a List of text strings.</span>
<span class="sd">                4. `spk_ids`: a List of speaker ID strings.</span>
<span class="sd">                5. `spk_feat`: a List of 2d `torch.Tensor` with equal lengths.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary mapping strings to either torch.Tensor or List, where:</span>
<span class="sd">                - feat and spk_feat are three-dimensional torch.Tensor</span>
<span class="sd">                - text and spk_ids are lists of raw strings whose discretization is done in the Model object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># --- 1. Pad Speech Data and Stack them together --- #</span>
        <span class="k">if</span> <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># para init</span>
            <span class="n">feat_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">ele</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]])</span>
            <span class="n">batch_size</span><span class="p">,</span> <span class="n">feat_maxlen</span><span class="p">,</span> <span class="n">feat_dim</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]),</span>
                <span class="n">feat_len</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># acoustic feature padding, feat.dtype needs to match the type of model parameters (torch.float32)</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">feat_maxlen</span><span class="p">,</span> <span class="n">feat_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1"># overwrite the padding matrix with each feat vector</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="c1"># process feat data based on data type</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">feat</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">feat_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">feat</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">feat_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># only support np.ndarray and torch.Tensor now</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>

            <span class="c1"># update &#39;feat&#39; and attach &#39;feat_len&#39; for later model forward</span>
            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat</span>
            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat_len</span>

        <span class="c1"># --- 2. Pad Pitch Data and Stack them together --- #</span>
        <span class="k">if</span> <span class="s2">&quot;pitch&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># para init</span>
            <span class="n">pitch_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">ele</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]])</span>
            <span class="n">batch_size</span><span class="p">,</span> <span class="n">pitch_maxlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]),</span> <span class="n">pitch_len</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="c1"># pitch padding, pitch.dtype needs to match the type of model parameters (torch.float32)</span>
            <span class="n">pitch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pitch_maxlen</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1"># overwrite the padding matrix with each pitch vector</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="c1"># process feat data based on data type</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">pitch</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">pitch_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">pitch</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">pitch_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># only support np.ndarray and torch.Tensor now</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>

            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitch</span>
            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitch_len</span>

        <span class="c1"># --- 3. Separate Phoneme Duration Data into Text Data and Duration Data --- #</span>
        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># para init</span>
            <span class="n">batch_size</span><span class="p">,</span> <span class="n">duration_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ele</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]]</span>
            <span class="p">)</span>

            <span class="c1"># duration padding, feat.dtype needs to match the type of model parameters (torch.float32)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">duration_len</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>
            <span class="c1"># overwrite the padding matrix with each duration vector</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="c1"># process duration data based on data type</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">)):</span>
                    <span class="n">duration</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">duration_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">duration</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">duration_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> only supports np.ndarray and torch.Tensor now!&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># attach &#39;duration&#39; and &#39;duration_len&#39; for model forward</span>
            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_len</span>

        <span class="c1"># --- 4. Stack Speaker Embedding Feature together --- #</span>
        <span class="k">if</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">batch_dict</span>

    <span class="k">def</span> <span class="nf">extract_main_data_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function that loads speech-text data from the disk. If the speech is in the form of raw waveforms,</span>
<span class="sd">        the last dimension should be expanded to 1 of raw speech for compatibility with acoustic feature.</span>

<span class="sd">        Args:</span>
<span class="sd">            main_data: Dict[str, str]</span>
<span class="sd">                The keys of the input main_data dictionary should be one of the following:</span>
<span class="sd">                    1. &#39;feat&#39;: speech features, can be either raw waveforms or acoustic features like log-mel or MFCC.</span>
<span class="sd">                    2. &#39;text&#39;: transcript text, in the form of raw string. The tokenization will be done in the ASR and</span>
<span class="sd">                    TTS models.</span>
<span class="sd">                    3. &#39;duration&#39;: phoneme durations. used for training fastspeech2 model.</span>
<span class="sd">                    4. &#39;spk_ids&#39;: speaker ID, in the form of raw string. The speaker discretization will be done in the</span>
<span class="sd">                    ASR and TTS models.</span>
<span class="sd">                    5. &#39;spk_feat&#39;: speaker embedding features.</span>
<span class="sd">                `spk_ids` and `spk_feat` are designed for multi-speaker TTS model and are not mandatory to be included</span>
<span class="sd">                in `main_data; &#39;feat&#39; and &#39;text&#39; are mandatory to be included for ASR and TTS training.</span>
<span class="sd">                However, during model testing, we can choose to only include one of &#39;feat&#39; and &#39;text&#39; here to reduce the</span>
<span class="sd">                CPU burden.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `feat` and `spk_feat` are in the form of two-dimensional `torch.Tensor`;</span>
<span class="sd">            `text` and `spk_ids` are in the form of raw strings whose discretization is done in the Model object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">),</span> <span class="s2">&quot;Please at least include one of &#39;feat&#39; and &#39;text&#39; in a single batch.&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;spk_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;spk_feat&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown data name </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">! &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, the key in &#39;main_data&#39; must be one of &quot;</span>
                    <span class="s2">&quot;&#39;feat&#39; (for paths of raw waveforms or acoustic features), &quot;</span>
                    <span class="s2">&quot;&#39;text&#39; (for transcript text data), &quot;</span>
                    <span class="s2">&quot;&#39;duration&#39; (for phoneme duration data), &quot;</span>
                    <span class="s2">&quot;&#39;spk_ids&#39; (for speaker IDs), &quot;</span>
                    <span class="s2">&quot;&#39;spk_feat&#39; (for speaker embedding features).&quot;</span>
                <span class="p">)</span>

        <span class="c1"># --- 1. Speech Data Extraction --- #</span>
        <span class="k">if</span> <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># read the selected data speech feature as a tensor by its path</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">],</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">],</span> <span class="n">return_sample_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># sometimes the extracted waveform data from an audio file can be empty, skip the current file if that happens</span>
            <span class="k">if</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># on-the-fly downsampling if extracted sampling rate is larger than the built-in one</span>
            <span class="k">if</span> <span class="n">sample_rate</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;wav_resampler_dict&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wav_resampler_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">sample_rate</span><span class="p">:</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resample</span><span class="p">(</span>
                            <span class="n">orig_freq</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">new_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
                        <span class="p">)</span>
                    <span class="p">}</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wav_resampler_dict</span><span class="p">[</span><span class="n">sample_rate</span><span class="p">](</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># extracted waveforms could not have lower sampling rate than the built-in one</span>
            <span class="k">elif</span> <span class="n">sample_rate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The current waveform has the lower sampling rate than </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># perturb the speed of the extracted speech if specified</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;speed_resampler_list&quot;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">sample_rate</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Your given sample rate (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">) is different from the real one gotten from the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;waveform (</span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">)!&quot;</span>
                <span class="p">)</span>
                <span class="n">resampler_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_resampler_list</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_resampler_list</span><span class="p">[</span><span class="n">resampler_index</span><span class="p">](</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># extract the pitch from the speech on-the-fly</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pitch_extract_fn&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch_extract_fn</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">])</span>
                <span class="c1"># IndexError means all the pitch values are unvoiced (=0.0)</span>
                <span class="c1"># return None to remove this utterance from the current batch</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># --- 2. Transcript Text Extraction --- #</span>
        <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># text length is not returned because the text here is just a raw string</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="nb">str</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The &#39;text&#39; data should be given as a string, but got </span><span class="si">{</span><span class="n">main_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># for the text data in the format of a list</span>
            <span class="k">if</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># split the text into individual tokens by a comma followed a blank</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
                <span class="c1"># remove the single quote marks surrounding each token if needed</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">token</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="c1"># process the raw string by G2P if specified</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;g2p&quot;</span><span class="p">):</span>
                <span class="n">phn_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">phn</span> <span class="k">if</span> <span class="n">phn</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="k">else</span> <span class="s2">&quot;&lt;space&gt;&quot;</span>
                    <span class="k">for</span> <span class="n">phn</span> <span class="ow">in</span> <span class="n">phn_list</span>
                    <span class="k">if</span> <span class="n">phn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">abnormal_phns</span>
                <span class="p">]</span>

        <span class="c1"># --- 3. Phoneme Duration Extraction --- #</span>
        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># text length is not returned because the text here is just a raw string</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">str</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The &#39;duration&#39; data should be given as a string, but got </span><span class="si">{</span><span class="n">main_data</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># for the text data in the format of a list</span>
            <span class="k">if</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
                <span class="s2">&quot;]&quot;</span>
            <span class="p">):</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># split the text into individual tokens by a comma followed a blank</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
                <span class="c1"># remove the single quote marks surrounding each token if needed</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">duration</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">duration</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;duration&#39; string should be surrounded by a pair of square brackets!&quot;</span>
                <span class="p">)</span>

        <span class="c1"># --- 4. Silence Trimming at the two ends --- #</span>
        <span class="c1"># trim the silence at two ends of the waveforms if the phoneme sequence starts or ends with spaces</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span> <span class="ow">or</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span>
        <span class="p">):</span>
            <span class="c1"># trim both feat and text</span>
            <span class="k">if</span> <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span>
                    <span class="s2">&quot;If you want to trim the silence at two ends of speech, &quot;</span>
                    <span class="s2">&quot;please give &#39;duration&#39; in &#39;main_data&#39; of the item &#39;dataset_conf&#39; under &#39;data_cfg&#39;.&quot;</span>
                <span class="p">)</span>
                <span class="n">front_trim_len</span><span class="p">,</span> <span class="n">tail_trim_len</span><span class="p">,</span> <span class="n">total_duration</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="nb">sum</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># sum up all the silence tokens at the beginning</span>
                    <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                        <span class="n">front_trim_len</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span>
                            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span>
                        <span class="p">)</span>
                    <span class="c1"># sum up all the silence tokens at the end</span>
                    <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                        <span class="n">tail_trim_len</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">)</span>
                <span class="c1"># IndexError means the text is full of &#39;&lt;space&gt;&#39;</span>
                <span class="c1"># return None to remove this utterance from the current batch</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="c1"># normalize the trimming lengths by the total duration length</span>
                <span class="n">front_trim_len</span><span class="p">,</span> <span class="n">tail_trim_len</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">front_trim_len</span> <span class="o">/</span> <span class="n">total_duration</span><span class="p">,</span>
                    <span class="n">tail_trim_len</span> <span class="o">/</span> <span class="n">total_duration</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># trim the extra silence in feat (waveforms or acoustic features)</span>
                <span class="n">feat_start</span><span class="p">,</span> <span class="n">feat_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">front_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">])</span>
                <span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tail_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]))</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">feat_start</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">feat_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][:</span><span class="o">-</span><span class="n">feat_end</span><span class="p">]</span>

                <span class="c1"># also trim the two ends of pitch values if extracted</span>
                <span class="k">if</span> <span class="s2">&quot;pitch&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">pitch_start</span><span class="p">,</span> <span class="n">pitch_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">front_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">])</span>
                    <span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tail_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]))</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">pitch_start</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">pitch_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][:</span><span class="o">-</span><span class="n">pitch_end</span><span class="p">]</span>

            <span class="c1"># only trim text if feat is not given</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># sum up all the &lt;space&gt; tokens at the beginning</span>
                    <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="c1"># sum up all the &lt;space&gt; tokens at the end</span>
                    <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># IndexError means the text is full of &#39;&lt;space&gt;&#39;</span>
                <span class="c1"># return None to remove this utterance from the current batch</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># --- 5. Randomly Masking the text data by unknown tokens (After silence trimming for data safety) --- #</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">List</span>
            <span class="p">),</span> <span class="s2">&quot;If you want to activate unk_mask_prob, text must be given in the &#39;main_date&#39; tag as a token sequence.&quot;</span>

            <span class="c1"># Get the start and end indices of words based on the positions of space tokens</span>
            <span class="n">space_indices</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span>
            <span class="p">]</span>
            <span class="n">word_start_indices</span><span class="p">,</span> <span class="n">word_end_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="n">s_i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">s_i</span> <span class="ow">in</span> <span class="n">space_indices</span>
            <span class="p">],</span> <span class="n">space_indices</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])]</span>

            <span class="c1"># Determine which words to mask</span>
            <span class="n">word_mask_flags</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_start_indices</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span>
            <span class="p">)</span>

            <span class="n">_tmp_text</span><span class="p">,</span> <span class="n">_tmp_duration</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_mask_flags</span><span class="p">)):</span>
                <span class="c1"># If the word should be masked, add an &#39;&lt;unk&gt;&#39; token</span>
                <span class="k">if</span> <span class="n">word_mask_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">_tmp_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">_sum_duration</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span>
                                <span class="n">word_start_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">_tmp_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">_sum_duration</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

                <span class="c1"># If the word shouldn&#39;t be masked, add the original tokens of the word</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_tmp_text</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span>
                        <span class="n">word_start_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">_tmp_duration</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span>
                            <span class="n">word_start_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">]</span>

                <span class="c1"># Add space tokens and their durations between words, except for the last word</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_mask_flags</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">_tmp_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">_tmp_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

            <span class="c1"># Update main_data with the new text and duration information</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp_text</span>
            <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp_duration</span>

        <span class="c1"># --- 6. Speaker ID Extraction --- #</span>
        <span class="k">if</span> <span class="s2">&quot;spk_ids&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># the speaker ID here is just a raw string</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_ids&quot;</span><span class="p">],</span> <span class="nb">str</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The &#39;spk_ids&#39; data should be given as a string, but got </span><span class="si">{</span><span class="n">main_data</span><span class="p">[</span><span class="s1">&#39;spk_ids&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># --- 7. Speaker Embedding Feature --- #</span>
        <span class="k">if</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># read the selected data speech feature as a tensor by its path</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">],</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">main_data</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(sample_rate=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;g2p&quot;</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">+=</span> <span class="s2">&quot;, use_g2p=True&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;speed_resampler_list&quot;</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, speed_perturb_range=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">perturb_range</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pitch_extract_fn&quot;</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">+=</span> <span class="s2">&quot;, pitch_extract=True&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, unk_mask_prob=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">outputs</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="dataset.speech_text.SpeechTextDataset.collate_main_data_fn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">collate_main_data_fn</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>The utterances used for training ASR and TTS models may have different lengths, so we need to do the
padding operations to make them equal in length.</p>
<p>The loaded speech feature vectors will be arranged into a single matrix with 0 padding at the end of short
vectors. Text data remains unprocessed strings and the tokenization will be done later in the model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.List">List</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The keys of the input <code>batch_dict</code> dictionary should be one of the following:
1. <code>feat</code>: a List of 2d <code>torch.Tensor</code> with different lengths.
2. <code>pitch</code>: a List of 1d <code>torch.Tensor</code> with different lengths.
3. <code>text</code>: a List of text strings.
4. <code>spk_ids</code>: a List of speaker ID strings.
5. <code>spk_feat</code>: a List of 2d <code>torch.Tensor</code> with equal lengths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="torch.Tensor">Tensor</span> or <span title="typing.List">List</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping strings to either torch.Tensor or List, where:
- feat and spk_feat are three-dimensional torch.Tensor
- text and spk_ids are lists of raw strings whose discretization is done in the Model object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/dataset/speech_text.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">collate_main_data_fn</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">batch_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="ow">or</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The utterances used for training ASR and TTS models may have different lengths, so we need to do the</span>
<span class="sd">    padding operations to make them equal in length.</span>

<span class="sd">    The loaded speech feature vectors will be arranged into a single matrix with 0 padding at the end of short</span>
<span class="sd">    vectors. Text data remains unprocessed strings and the tokenization will be done later in the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_dict (Dict[str, List]): The keys of the input `batch_dict` dictionary should be one of the following:</span>
<span class="sd">            1. `feat`: a List of 2d `torch.Tensor` with different lengths.</span>
<span class="sd">            2. `pitch`: a List of 1d `torch.Tensor` with different lengths.</span>
<span class="sd">            3. `text`: a List of text strings.</span>
<span class="sd">            4. `spk_ids`: a List of speaker ID strings.</span>
<span class="sd">            5. `spk_feat`: a List of 2d `torch.Tensor` with equal lengths.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping strings to either torch.Tensor or List, where:</span>
<span class="sd">            - feat and spk_feat are three-dimensional torch.Tensor</span>
<span class="sd">            - text and spk_ids are lists of raw strings whose discretization is done in the Model object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --- 1. Pad Speech Data and Stack them together --- #</span>
    <span class="k">if</span> <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># para init</span>
        <span class="n">feat_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">ele</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]])</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">feat_maxlen</span><span class="p">,</span> <span class="n">feat_dim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]),</span>
            <span class="n">feat_len</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
            <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># acoustic feature padding, feat.dtype needs to match the type of model parameters (torch.float32)</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">feat_maxlen</span><span class="p">,</span> <span class="n">feat_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># overwrite the padding matrix with each feat vector</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># process feat data based on data type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">feat</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">feat_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">feat</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">feat_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># only support np.ndarray and torch.Tensor now</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>

        <span class="c1"># update &#39;feat&#39; and attach &#39;feat_len&#39; for later model forward</span>
        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat</span>
        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;feat_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat_len</span>

    <span class="c1"># --- 2. Pad Pitch Data and Stack them together --- #</span>
    <span class="k">if</span> <span class="s2">&quot;pitch&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># para init</span>
        <span class="n">pitch_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">ele</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]])</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">pitch_maxlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]),</span> <span class="n">pitch_len</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># pitch padding, pitch.dtype needs to match the type of model parameters (torch.float32)</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pitch_maxlen</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># overwrite the padding matrix with each pitch vector</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># process feat data based on data type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">pitch</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">pitch_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">pitch</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">pitch_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># only support np.ndarray and torch.Tensor now</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>

        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitch</span>
        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;pitch_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitch_len</span>

    <span class="c1"># --- 3. Separate Phoneme Duration Data into Text Data and Duration Data --- #</span>
    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># para init</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">duration_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ele</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="c1"># duration padding, feat.dtype needs to match the type of model parameters (torch.float32)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">duration_len</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
        <span class="p">)</span>
        <span class="c1"># overwrite the padding matrix with each duration vector</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># process duration data based on data type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">)):</span>
                <span class="n">duration</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">duration_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                    <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">duration</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span> <span class="n">duration_len</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> only supports np.ndarray and torch.Tensor now!&quot;</span>
                <span class="p">)</span>

        <span class="c1"># attach &#39;duration&#39; and &#39;duration_len&#39; for model forward</span>
        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;duration_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_len</span>

    <span class="c1"># --- 4. Stack Speaker Embedding Feature together --- #</span>
    <span class="k">if</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">batch_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dataset.speech_text.SpeechTextDataset.data_len_register_fn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">data_len_register_fn</span><span class="p">(</span><span class="n">main_data</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">



    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, int or float] or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If 'text' is given in main_data, return the number of characters in each sentence.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, int or float] or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Otherwise, return None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/dataset/speech_text.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">data_len_register_fn</span><span class="p">(</span>
    <span class="n">main_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        If &#39;text&#39; is given in main_data, return the number of characters in each sentence.</span>
<span class="sd">        Otherwise, return None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dataset.speech_text.SpeechTextDataset.dataset_init_fn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dataset_init_fn</span><span class="p">(</span><span class="n">use_g2p</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unk_mask_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">use_speed_perturb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span> <span class="n">perturb_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span> <span class="n">pitch_conf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Dataset initialization function.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>use_g2p</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to process the raw string by G2P. We don't
recommend you to turn it on because on-the-fly transformer from string to
phoneme list consumes a lot of CPU resources. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unk_mask_prob</code>
            </td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Probability of masking tokens as unknown.
Defaults to 0.0.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_speed_perturb</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to perturb the speed of the
waveforms. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_rate</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Audio sampling rate in Hz. Defaults to 16000.</p>
              </div>
            </td>
            <td>
                  <code>16000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>perturb_range</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Range of speed perturbation factors.
Defaults to [0.9, 1.0, 1.1].</p>
              </div>
            </td>
            <td>
                  <code>[0.9, 1.0, 1.1]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pitch_conf</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration given to convert_wav_to_pitch()
for pitch extraction. If not given, pitch extraction will not be done
on-the-fly. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Phoneme related: use_g2p
Waveform related: unk_mask_prob, use_speed_perturb, sample_rate, perturb_range
Pitch related: pitch_conf</p>
</details>
            <details class="quote">
              <summary>Source code in <code>speechain/dataset/speech_text.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dataset_init_fn</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">use_g2p</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">unk_mask_prob</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">use_speed_perturb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">,</span>
    <span class="n">perturb_range</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span>
    <span class="n">pitch_conf</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataset initialization function.</span>

<span class="sd">    Args:</span>
<span class="sd">        use_g2p (bool, optional): Whether to process the raw string by G2P. We don&#39;t</span>
<span class="sd">            recommend you to turn it on because on-the-fly transformer from string to</span>
<span class="sd">            phoneme list consumes a lot of CPU resources. Defaults to False.</span>

<span class="sd">        unk_mask_prob (float, optional): Probability of masking tokens as unknown.</span>
<span class="sd">            Defaults to 0.0.</span>
<span class="sd">        use_speed_perturb (bool, optional): Whether to perturb the speed of the</span>
<span class="sd">            waveforms. Defaults to False.</span>
<span class="sd">        sample_rate (int, optional): Audio sampling rate in Hz. Defaults to 16000.</span>
<span class="sd">        perturb_range (List[float], optional): Range of speed perturbation factors.</span>
<span class="sd">            Defaults to [0.9, 1.0, 1.1].</span>

<span class="sd">        pitch_conf (Dict, optional): The configuration given to convert_wav_to_pitch()</span>
<span class="sd">            for pitch extraction. If not given, pitch extraction will not be done</span>
<span class="sd">            on-the-fly. Defaults to None.</span>

<span class="sd">    Note:</span>
<span class="sd">        Phoneme related: use_g2p</span>
<span class="sd">        Waveform related: unk_mask_prob, use_speed_perturb, sample_rate, perturb_range</span>
<span class="sd">        Pitch related: pitch_conf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># register sampling rate for later check</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The waveform sampling rate of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is set to </span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;All the extracted waveforms will be downsampled into </span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2"> if needed. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Please make sure that </span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2"> is the same with your model! &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;If this is not your target sampling rate, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;please change it by the key &#39;sample_rate&#39; in the item &#39;dataset_conf&#39; under &#39;data_cfg&#39;. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;If you want to train Language Models or synthesize speech by text, you can ignore this warning.&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">unk_mask_prob</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;unk_mask_prob should be a float number in [0, 1], but got </span><span class="si">{</span><span class="n">unk_mask_prob</span><span class="si">}</span><span class="s2">!&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span> <span class="o">=</span> <span class="n">unk_mask_prob</span>

    <span class="c1"># phoneme extraction</span>
    <span class="k">if</span> <span class="n">use_g2p</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span> <span class="o">=</span> <span class="n">G2p</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">use_speed_perturb</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perturb_range</span> <span class="o">=</span> <span class="n">perturb_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_resampler_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">torchaudio</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resample</span><span class="p">(</span>
                <span class="n">orig_freq</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">new_freq</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">perturb_range</span>
        <span class="p">]</span>

    <span class="c1"># pitch extraction</span>
    <span class="k">if</span> <span class="n">pitch_conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;sr&quot;</span> <span class="ow">in</span> <span class="n">pitch_conf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">pitch_conf</span><span class="p">[</span><span class="s2">&quot;sr&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The sampling rate in your given &#39;pitch_conf&#39; (</span><span class="si">{</span><span class="n">pitch_conf</span><span class="p">[</span><span class="s1">&#39;sr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) is different from your &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;given sample_rate (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">)!&quot;</span>
            <span class="p">)</span>
        <span class="n">pitch_conf</span><span class="p">[</span><span class="s2">&quot;sr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch_extract_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">convert_wav_to_pitch</span><span class="p">,</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">pitch_conf</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dataset.speech_text.SpeechTextDataset.extract_main_data_fn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_main_data_fn</span><span class="p">(</span><span class="n">main_data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>The function that loads speech-text data from the disk. If the speech is in the form of raw waveforms,
the last dimension should be expanded to 1 of raw speech for compatibility with acoustic feature.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>main_data</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, str]
The keys of the input main_data dictionary should be one of the following:
    1. 'feat': speech features, can be either raw waveforms or acoustic features like log-mel or MFCC.
    2. 'text': transcript text, in the form of raw string. The tokenization will be done in the ASR and
    TTS models.
    3. 'duration': phoneme durations. used for training fastspeech2 model.
    4. 'spk_ids': speaker ID, in the form of raw string. The speaker discretization will be done in the
    ASR and TTS models.
    5. 'spk_feat': speaker embedding features.
<code>spk_ids</code> and <code>spk_feat</code> are designed for multi-speaker TTS model and are not mandatory to be included
in `main_data; 'feat' and 'text' are mandatory to be included for ASR and TTS training.
However, during model testing, we can choose to only include one of 'feat' and 'text' here to reduce the
CPU burden.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>] or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>feat</code> and <code>spk_feat</code> are in the form of two-dimensional <code>torch.Tensor</code>;</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>] or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>text</code> and <code>spk_ids</code> are in the form of raw strings whose discretization is done in the Model object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/dataset/speech_text.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_main_data_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function that loads speech-text data from the disk. If the speech is in the form of raw waveforms,</span>
<span class="sd">    the last dimension should be expanded to 1 of raw speech for compatibility with acoustic feature.</span>

<span class="sd">    Args:</span>
<span class="sd">        main_data: Dict[str, str]</span>
<span class="sd">            The keys of the input main_data dictionary should be one of the following:</span>
<span class="sd">                1. &#39;feat&#39;: speech features, can be either raw waveforms or acoustic features like log-mel or MFCC.</span>
<span class="sd">                2. &#39;text&#39;: transcript text, in the form of raw string. The tokenization will be done in the ASR and</span>
<span class="sd">                TTS models.</span>
<span class="sd">                3. &#39;duration&#39;: phoneme durations. used for training fastspeech2 model.</span>
<span class="sd">                4. &#39;spk_ids&#39;: speaker ID, in the form of raw string. The speaker discretization will be done in the</span>
<span class="sd">                ASR and TTS models.</span>
<span class="sd">                5. &#39;spk_feat&#39;: speaker embedding features.</span>
<span class="sd">            `spk_ids` and `spk_feat` are designed for multi-speaker TTS model and are not mandatory to be included</span>
<span class="sd">            in `main_data; &#39;feat&#39; and &#39;text&#39; are mandatory to be included for ASR and TTS training.</span>
<span class="sd">            However, during model testing, we can choose to only include one of &#39;feat&#39; and &#39;text&#39; here to reduce the</span>
<span class="sd">            CPU burden.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `feat` and `spk_feat` are in the form of two-dimensional `torch.Tensor`;</span>
<span class="sd">        `text` and `spk_ids` are in the form of raw strings whose discretization is done in the Model object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">),</span> <span class="s2">&quot;Please at least include one of &#39;feat&#39; and &#39;text&#39; in a single batch.&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;spk_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;spk_feat&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown data name </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, the key in &#39;main_data&#39; must be one of &quot;</span>
                <span class="s2">&quot;&#39;feat&#39; (for paths of raw waveforms or acoustic features), &quot;</span>
                <span class="s2">&quot;&#39;text&#39; (for transcript text data), &quot;</span>
                <span class="s2">&quot;&#39;duration&#39; (for phoneme duration data), &quot;</span>
                <span class="s2">&quot;&#39;spk_ids&#39; (for speaker IDs), &quot;</span>
                <span class="s2">&quot;&#39;spk_feat&#39; (for speaker embedding features).&quot;</span>
            <span class="p">)</span>

    <span class="c1"># --- 1. Speech Data Extraction --- #</span>
    <span class="k">if</span> <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># read the selected data speech feature as a tensor by its path</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">],</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">],</span> <span class="n">return_sample_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># sometimes the extracted waveform data from an audio file can be empty, skip the current file if that happens</span>
        <span class="k">if</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># on-the-fly downsampling if extracted sampling rate is larger than the built-in one</span>
        <span class="k">if</span> <span class="n">sample_rate</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;wav_resampler_dict&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wav_resampler_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">sample_rate</span><span class="p">:</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resample</span><span class="p">(</span>
                        <span class="n">orig_freq</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">new_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
                    <span class="p">)</span>
                <span class="p">}</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wav_resampler_dict</span><span class="p">[</span><span class="n">sample_rate</span><span class="p">](</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># extracted waveforms could not have lower sampling rate than the built-in one</span>
        <span class="k">elif</span> <span class="n">sample_rate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The current waveform has the lower sampling rate than </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># perturb the speed of the extracted speech if specified</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;speed_resampler_list&quot;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">sample_rate</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Your given sample rate (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">) is different from the real one gotten from the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;waveform (</span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">)!&quot;</span>
            <span class="p">)</span>
            <span class="n">resampler_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_resampler_list</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_resampler_list</span><span class="p">[</span><span class="n">resampler_index</span><span class="p">](</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># extract the pitch from the speech on-the-fly</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pitch_extract_fn&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch_extract_fn</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">])</span>
            <span class="c1"># IndexError means all the pitch values are unvoiced (=0.0)</span>
            <span class="c1"># return None to remove this utterance from the current batch</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># --- 2. Transcript Text Extraction --- #</span>
    <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># text length is not returned because the text here is just a raw string</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The &#39;text&#39; data should be given as a string, but got </span><span class="si">{</span><span class="n">main_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># for the text data in the format of a list</span>
        <span class="k">if</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># split the text into individual tokens by a comma followed a blank</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="c1"># remove the single quote marks surrounding each token if needed</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">token</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="c1"># process the raw string by G2P if specified</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;g2p&quot;</span><span class="p">):</span>
            <span class="n">phn_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">phn</span> <span class="k">if</span> <span class="n">phn</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="k">else</span> <span class="s2">&quot;&lt;space&gt;&quot;</span>
                <span class="k">for</span> <span class="n">phn</span> <span class="ow">in</span> <span class="n">phn_list</span>
                <span class="k">if</span> <span class="n">phn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">abnormal_phns</span>
            <span class="p">]</span>

    <span class="c1"># --- 3. Phoneme Duration Extraction --- #</span>
    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># text length is not returned because the text here is just a raw string</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The &#39;duration&#39; data should be given as a string, but got </span><span class="si">{</span><span class="n">main_data</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># for the text data in the format of a list</span>
        <span class="k">if</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
            <span class="s2">&quot;]&quot;</span>
        <span class="p">):</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># split the text into individual tokens by a comma followed a blank</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="c1"># remove the single quote marks surrounding each token if needed</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">duration</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">duration</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;duration&#39; string should be surrounded by a pair of square brackets!&quot;</span>
            <span class="p">)</span>

    <span class="c1"># --- 4. Silence Trimming at the two ends --- #</span>
    <span class="c1"># trim the silence at two ends of the waveforms if the phoneme sequence starts or ends with spaces</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span> <span class="ow">or</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span>
    <span class="p">):</span>
        <span class="c1"># trim both feat and text</span>
        <span class="k">if</span> <span class="s2">&quot;feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span>
                <span class="s2">&quot;If you want to trim the silence at two ends of speech, &quot;</span>
                <span class="s2">&quot;please give &#39;duration&#39; in &#39;main_data&#39; of the item &#39;dataset_conf&#39; under &#39;data_cfg&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="n">front_trim_len</span><span class="p">,</span> <span class="n">tail_trim_len</span><span class="p">,</span> <span class="n">total_duration</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="nb">sum</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># sum up all the silence tokens at the beginning</span>
                <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                    <span class="n">front_trim_len</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span>
                    <span class="p">)</span>
                <span class="c1"># sum up all the silence tokens at the end</span>
                <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                    <span class="n">tail_trim_len</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="c1"># IndexError means the text is full of &#39;&lt;space&gt;&#39;</span>
            <span class="c1"># return None to remove this utterance from the current batch</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># normalize the trimming lengths by the total duration length</span>
            <span class="n">front_trim_len</span><span class="p">,</span> <span class="n">tail_trim_len</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">front_trim_len</span> <span class="o">/</span> <span class="n">total_duration</span><span class="p">,</span>
                <span class="n">tail_trim_len</span> <span class="o">/</span> <span class="n">total_duration</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># trim the extra silence in feat (waveforms or acoustic features)</span>
            <span class="n">feat_start</span><span class="p">,</span> <span class="n">feat_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">front_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">])</span>
            <span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tail_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]))</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][</span><span class="n">feat_start</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">feat_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;feat&quot;</span><span class="p">][:</span><span class="o">-</span><span class="n">feat_end</span><span class="p">]</span>

            <span class="c1"># also trim the two ends of pitch values if extracted</span>
            <span class="k">if</span> <span class="s2">&quot;pitch&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pitch_start</span><span class="p">,</span> <span class="n">pitch_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">front_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">])</span>
                <span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tail_trim_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]))</span>
                <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][</span><span class="n">pitch_start</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">pitch_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">][:</span><span class="o">-</span><span class="n">pitch_end</span><span class="p">]</span>

        <span class="c1"># only trim text if feat is not given</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># sum up all the &lt;space&gt; tokens at the beginning</span>
                <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c1"># sum up all the &lt;space&gt; tokens at the end</span>
                <span class="k">while</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">:</span>
                    <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># IndexError means the text is full of &#39;&lt;space&gt;&#39;</span>
            <span class="c1"># return None to remove this utterance from the current batch</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># --- 5. Randomly Masking the text data by unknown tokens (After silence trimming for data safety) --- #</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">List</span>
        <span class="p">),</span> <span class="s2">&quot;If you want to activate unk_mask_prob, text must be given in the &#39;main_date&#39; tag as a token sequence.&quot;</span>

        <span class="c1"># Get the start and end indices of words based on the positions of space tokens</span>
        <span class="n">space_indices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;&lt;space&gt;&quot;</span>
        <span class="p">]</span>
        <span class="n">word_start_indices</span><span class="p">,</span> <span class="n">word_end_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">s_i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">s_i</span> <span class="ow">in</span> <span class="n">space_indices</span>
        <span class="p">],</span> <span class="n">space_indices</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])]</span>

        <span class="c1"># Determine which words to mask</span>
        <span class="n">word_mask_flags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_start_indices</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_mask_prob</span>
        <span class="p">)</span>

        <span class="n">_tmp_text</span><span class="p">,</span> <span class="n">_tmp_duration</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_mask_flags</span><span class="p">)):</span>
            <span class="c1"># If the word should be masked, add an &#39;&lt;unk&gt;&#39; token</span>
            <span class="k">if</span> <span class="n">word_mask_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">_tmp_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">_sum_duration</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span>
                            <span class="n">word_start_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">_tmp_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">_sum_duration</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

            <span class="c1"># If the word shouldn&#39;t be masked, add the original tokens of the word</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_tmp_text</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span>
                    <span class="n">word_start_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">_tmp_duration</span> <span class="o">+=</span> <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span>
                        <span class="n">word_start_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">]</span>

            <span class="c1"># Add space tokens and their durations between words, except for the last word</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_mask_flags</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_tmp_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">_tmp_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">][</span><span class="n">word_end_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

        <span class="c1"># Update main_data with the new text and duration information</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp_text</span>
        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp_duration</span>

    <span class="c1"># --- 6. Speaker ID Extraction --- #</span>
    <span class="k">if</span> <span class="s2">&quot;spk_ids&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># the speaker ID here is just a raw string</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_ids&quot;</span><span class="p">],</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The &#39;spk_ids&#39; data should be given as a string, but got </span><span class="si">{</span><span class="n">main_data</span><span class="p">[</span><span class="s1">&#39;spk_ids&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># --- 7. Speaker Embedding Feature --- #</span>
    <span class="k">if</span> <span class="s2">&quot;spk_feat&quot;</span> <span class="ow">in</span> <span class="n">main_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># read the selected data speech feature as a tensor by its path</span>
        <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_data_by_path</span><span class="p">(</span>
            <span class="n">main_data</span><span class="p">[</span><span class="s2">&quot;spk_feat&quot;</span><span class="p">],</span> <span class="n">return_tensor</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">main_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>