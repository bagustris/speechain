
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Speechain Toolkit">
      
      
      
      
        <link rel="prev" href="../module/transformer/pos_enc/">
      
      
        <link rel="next" href="../optim_sche/abs/">
      
      
      <link rel="icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.46">
    
    
      
        <title>monitor - Speechain</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/code_select.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#monitor" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Speechain" class="md-header__button md-logo" aria-label="Speechain" data-md-component="logo">
      
  <img src="../../img/speechain_inverted.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Speechain
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              monitor
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/bagustris/speechain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Speechain" class="md-nav__button md-logo" aria-label="Speechain" data-md-component="logo">
      
  <img src="../../img/speechain_inverted.png" alt="logo">

    </a>
    Speechain
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bagustris/speechain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Datasets
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ASR
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TTS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    criterion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            criterion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/accuracy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    accuracy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/att_guid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    att_guid
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/bce_logits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bce_logits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/cross_entropy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cross_entropy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/ctc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/error_rate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    error_rate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/fbeta_score/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fbeta_score
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/least_error/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    least_error
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../criterion/perplexity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    perplexity
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../dataset/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    dataset
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            dataset
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataset/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataset/speech_text/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech_text
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    infer_func
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            infer_func
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../infer_func/beam_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    beam_search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../infer_func/ctc_decoding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctc_decoding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../infer_func/tts_decoding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tts_decoding
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    iterator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            iterator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../iterator/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../iterator/block/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    block
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    model
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/ar_asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_asr
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/ar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_tts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/lm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/nar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nar_tts
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    module
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            module
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_2" >
        
          
          <label class="md-nav__link" for="__nav_5_6_2" id="__nav_5_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    augment
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_2">
            <span class="md-nav__icon md-icon"></span>
            augment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/augment/specaug/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    specaug
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_3" >
        
          
          <label class="md-nav__link" for="__nav_5_6_3" id="__nav_5_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    conformer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_3">
            <span class="md-nav__icon md-icon"></span>
            conformer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/conformer/attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/conformer/encoder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    encoder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/conformer/pos_enc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pos_enc
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_4" >
        
          
          <label class="md-nav__link" for="__nav_5_6_4" id="__nav_5_6_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    decoder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_4">
            <span class="md-nav__icon md-icon"></span>
            decoder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/decoder/ar_asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_asr
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/decoder/ar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ar_tts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/decoder/nar_tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nar_tts
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_5" >
        
          
          <label class="md-nav__link" for="__nav_5_6_5" id="__nav_5_6_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    encoder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_5">
            <span class="md-nav__icon md-icon"></span>
            encoder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/encoder/asr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asr
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/encoder/tts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tts
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6_6" id="__nav_5_6_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    frontend
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_6">
            <span class="md-nav__icon md-icon"></span>
            frontend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/frontend/delta_feat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    delta_feat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/frontend/linear2mel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linear2mel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/frontend/speech2linear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech2linear
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/frontend/speech2mel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech2mel
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_7" >
        
          
          <label class="md-nav__link" for="__nav_5_6_7" id="__nav_5_6_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    norm
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_7">
            <span class="md-nav__icon md-icon"></span>
            norm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/norm/feat_norm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    feat_norm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_8" >
        
          
          <label class="md-nav__link" for="__nav_5_6_8" id="__nav_5_6_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    postnet
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_8">
            <span class="md-nav__icon md-icon"></span>
            postnet
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/postnet/conv1d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conv1d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/postnet/token/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    token
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_9" >
        
          
          <label class="md-nav__link" for="__nav_5_6_9" id="__nav_5_6_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    prenet
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_9">
            <span class="md-nav__icon md-icon"></span>
            prenet
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/prenet/conv1d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conv1d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/prenet/conv2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conv2d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/prenet/embed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    embed
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/prenet/linear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linear
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/prenet/spk_embed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    spk_embed
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/prenet/var_pred/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    var_pred
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_10" >
        
          
          <label class="md-nav__link" for="__nav_5_6_10" id="__nav_5_6_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    standalone
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_10">
            <span class="md-nav__icon md-icon"></span>
            standalone
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/standalone/lm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6_11" >
        
          
          <label class="md-nav__link" for="__nav_5_6_11" id="__nav_5_6_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    transformer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_6_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6_11">
            <span class="md-nav__icon md-icon"></span>
            transformer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/transformer/attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/transformer/decoder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    decoder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/transformer/encoder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    encoder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/transformer/feed_forward/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    feed_forward
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module/transformer/pos_enc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pos_enc
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    monitor
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    monitor
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#monitor" class="md-nav__link">
    <span class="md-ellipsis">
      monitor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.Monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Monitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.empty_queue" class="md-nav__link">
    <span class="md-ellipsis">
      empty_queue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.enqueue" class="md-nav__link">
    <span class="md-ellipsis">
      enqueue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.load_state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      load_state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.measure_time" class="md-nav__link">
    <span class="md-ellipsis">
      measure_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_consumed_memory" class="md-nav__link">
    <span class="md-ellipsis">
      record_consumed_memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_consumed_time" class="md-nav__link">
    <span class="md-ellipsis">
      record_consumed_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_criteria" class="md-nav__link">
    <span class="md-ellipsis">
      record_criteria
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_step_info" class="md-nav__link">
    <span class="md-ellipsis">
      record_step_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.refresh_step_records" class="md-nav__link">
    <span class="md-ellipsis">
      refresh_step_records
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.TestMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      TestMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TestMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.wait_empty_queues" class="md-nav__link">
    <span class="md-ellipsis">
      wait_empty_queues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.TrainMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      TrainMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      TrainValidMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainValidMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.finish_train_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_train_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.finish_valid_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_valid_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.load_state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      load_state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.start_train_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_train_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.start_valid_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_valid_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.train_step" class="md-nav__link">
    <span class="md-ellipsis">
      train_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.valid_model_snapshot" class="md-nav__link">
    <span class="md-ellipsis">
      valid_model_snapshot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.valid_step" class="md-nav__link">
    <span class="md-ellipsis">
      valid_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.wait_empty_queues" class="md-nav__link">
    <span class="md-ellipsis">
      wait_empty_queues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.ValidMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      ValidMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ValidMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.is_better" class="md-nav__link">
    <span class="md-ellipsis">
      is_better
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.model_insert" class="md-nav__link">
    <span class="md-ellipsis">
      model_insert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.model_snapshot" class="md-nav__link">
    <span class="md-ellipsis">
      model_snapshot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.save_aver_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_aver_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.update_best_and_pop_worst" class="md-nav__link">
    <span class="md-ellipsis">
      update_best_and_pop_worst
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.data_saving_logs" class="md-nav__link">
    <span class="md-ellipsis">
      data_saving_logs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    optim_sche
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            optim_sche
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optim_sche/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optim_sche/exp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optim_sche/noam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    noam
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    pyscripts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            pyscripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pyscripts/empty_file_checker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    empty_file_checker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pyscripts/folder_summarizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    folder_summarizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pyscripts/model_para_renamer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    model_para_renamer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pyscripts/phn_duaration_visualizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    phn_duaration_visualizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pyscripts/text_dist_visualizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    text_dist_visualizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pyscripts/wavlen_dist_visualizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wavlen_dist_visualizer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    runner
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../snapshooter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    snapshooter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_12" >
        
          
          <label class="md-nav__link" for="__nav_5_12" id="__nav_5_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    tokenizer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_12">
            <span class="md-nav__icon md-icon"></span>
            tokenizer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tokenizer/abs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tokenizer/char/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    char
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tokenizer/g2p/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    g2p
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tokenizer/sp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sp
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_13" >
        
          
          <label class="md-nav__link" for="__nav_5_13" id="__nav_5_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    utilbox
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_13">
            <span class="md-nav__icon md-icon"></span>
            utilbox
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/data_loading_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data_loading_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/data_saving_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data_saving_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/dump_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dump_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/eval_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eval_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/feat_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    feat_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/import_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    import_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/log_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    log_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/md_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    md_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/regex_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    regex_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/sb_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sb_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/spk_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    spk_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/tensor_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tensor_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/text_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    text_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/train_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    train_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/type_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    type_util
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilbox/yaml_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    yaml_util
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#monitor" class="md-nav__link">
    <span class="md-ellipsis">
      monitor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.Monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Monitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.empty_queue" class="md-nav__link">
    <span class="md-ellipsis">
      empty_queue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.enqueue" class="md-nav__link">
    <span class="md-ellipsis">
      enqueue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.load_state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      load_state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.measure_time" class="md-nav__link">
    <span class="md-ellipsis">
      measure_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_consumed_memory" class="md-nav__link">
    <span class="md-ellipsis">
      record_consumed_memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_consumed_time" class="md-nav__link">
    <span class="md-ellipsis">
      record_consumed_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_criteria" class="md-nav__link">
    <span class="md-ellipsis">
      record_criteria
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.record_step_info" class="md-nav__link">
    <span class="md-ellipsis">
      record_step_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.refresh_step_records" class="md-nav__link">
    <span class="md-ellipsis">
      refresh_step_records
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.Monitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.TestMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      TestMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TestMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TestMonitor.wait_empty_queues" class="md-nav__link">
    <span class="md-ellipsis">
      wait_empty_queues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.TrainMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      TrainMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainMonitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      TrainValidMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TrainValidMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.finish_train_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_train_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.finish_valid_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_valid_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.load_state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      load_state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.start_train_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_train_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.start_valid_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_valid_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.train_step" class="md-nav__link">
    <span class="md-ellipsis">
      train_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.valid_model_snapshot" class="md-nav__link">
    <span class="md-ellipsis">
      valid_model_snapshot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.valid_step" class="md-nav__link">
    <span class="md-ellipsis">
      valid_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.TrainValidMonitor.wait_empty_queues" class="md-nav__link">
    <span class="md-ellipsis">
      wait_empty_queues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.ValidMonitor" class="md-nav__link">
    <span class="md-ellipsis">
      ValidMonitor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ValidMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.finish_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      finish_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.is_better" class="md-nav__link">
    <span class="md-ellipsis">
      is_better
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.model_insert" class="md-nav__link">
    <span class="md-ellipsis">
      model_insert
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.model_snapshot" class="md-nav__link">
    <span class="md-ellipsis">
      model_snapshot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.monitor_init" class="md-nav__link">
    <span class="md-ellipsis">
      monitor_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.save_aver_model" class="md-nav__link">
    <span class="md-ellipsis">
      save_aver_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.start_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      start_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.state_dict" class="md-nav__link">
    <span class="md-ellipsis">
      state_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.step" class="md-nav__link">
    <span class="md-ellipsis">
      step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor.ValidMonitor.update_best_and_pop_worst" class="md-nav__link">
    <span class="md-ellipsis">
      update_best_and_pop_worst
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor.data_saving_logs" class="md-nav__link">
    <span class="md-ellipsis">
      data_saving_logs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>monitor</h1>

<div class="doc doc-object doc-module">



<a id="monitor"></a>
    <div class="doc doc-contents first">

        <p>Author: Heli Qi
Affiliation: NAIST
Date: 2022.07</p>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="monitor.Monitor" class="doc doc-heading">
            <code>Monitor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract Base Class (ABC) for a Monitor that keeps track of various aspects of training and evaluatio.</p>






              <details class="quote">
                <summary>Source code in <code>speechain/monitor.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Monitor</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract Base Class (ABC) for a Monitor that keeps track of various aspects of training and evaluatio.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">result_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the monitor class.</span>

<span class="sd">        Args:</span>
<span class="sd">            logger: A logger object for logging messages.</span>
<span class="sd">            args: Command line arguments passed as a Namespace object.</span>
<span class="sd">            result_path: Path to the directory where results should be saved.</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># Initialize shared members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">train_result_path</span>
            <span class="k">if</span> <span class="n">result_path</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">parse_path_args</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpus</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpus</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpus</span><span class="p">,</span> <span class="n">List</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">gpus</span><span class="p">]</span>

        <span class="c1"># Initialize shared record information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">consumed_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data_load_time</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_forward_time</span><span class="o">=</span><span class="p">[]),</span>
            <span class="n">consumed_memory</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
            <span class="n">criteria</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="c1"># Add GPU ranks to consumed_memory if they don&#39;t exist</span>
        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpus</span><span class="p">):</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Initialize step-level records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">consumed_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data_load_time</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_forward_time</span><span class="o">=</span><span class="p">[]),</span>
            <span class="n">criteria</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_init</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Initialize snapshooter for log snapshotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">snapshot_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">result_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span>
            <span class="n">snap_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="n">monitor_snapshot_conf</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Initialize multiprocessing event to enable communication with the snapshooter process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">snapshot_logs</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">snapshot_conf</span><span class="p">),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="n">Dict</span> <span class="ow">or</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueues logs into the logs_queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            logs:</span>
<span class="sd">                A dictionary or list of dictionaries containing logs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected logs to be a Dict or a List[Dict].&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">empty_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the logs queue is empty.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Boolean value indicating whether the logs queue is empty or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">measure_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Context manager for measuring time of execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            names (str or List[str]):</span>
<span class="sd">                Name or list of names for the operations to be timed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="k">yield</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">,</span> <span class="n">names</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">names</span>
        <span class="p">)</span>
        <span class="n">dict_pointer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_pointer</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dict_pointer</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">dict_pointer</span> <span class="o">=</span> <span class="n">dict_pointer</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">dict_pointer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">refresh_step_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refreshes the step records by resetting the values.</span>

<span class="sd">        Args:</span>
<span class="sd">            records (Dict, optional):</span>
<span class="sd">                A dictionary containing the records to be refreshed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_step_records</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">List</span><span class="p">):</span>
                    <span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unexpected type in records: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected records to be of type Dict.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_step_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">step_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records information at each step during training or evaluation.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str):</span>
<span class="sd">                Key under which information should be recorded.</span>
<span class="sd">            step_info (Dict):</span>
<span class="sd">                Dictionary containing the information to be recorded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># result is in the form of torch.Tensor, so it needs to be transformed by .item()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_consumed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records time consumed in each epoch during training or evaluation.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch_message (str):</span>
<span class="sd">                String to be included in the epoch message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The updated epoch message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- Consumed Time -- </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># Record data loading time</span>
        <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;data_load_time&quot;</span><span class="p">])</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total data load time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;data_load_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>

        <span class="c1"># Record model forward time</span>
        <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;model_forward_time&quot;</span><span class="p">])</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total model forward time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;model_forward_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">epoch_message</span>

    <span class="k">def</span> <span class="nf">record_consumed_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records memory consumed in each epoch during training or evaluation.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch_message (str):</span>
<span class="sd">                String to be included in the epoch message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The updated epoch message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- Consumed Memory -- </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="n">GPUtil</span><span class="o">.</span><span class="n">getGPUs</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;GPUtil.getGPUs() returns nothing at the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="p">)</span>

        <span class="c1"># Record consumed memory for each GPU</span>
        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpus</span><span class="p">):</span>
            <span class="c1"># recover the GPU number from &#39;CUDA_VISIBLE_DEVICES&#39;</span>
            <span class="k">if</span> <span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">gpu</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="n">gpu</span><span class="p">]</span>
                <span class="c1"># if gpu is in the form of the local ID, it will be converted into an integer for List indexing</span>
                <span class="k">if</span> <span class="n">gpu</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">gpu</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span>
                <span class="c1"># if gpu is in the form of the UUID, it will be kept as a string</span>

            <span class="c1"># --- torch.cuda is only able to report the GPU used in the current rank --- #</span>
            <span class="c1"># --- but torch.cuda can report the precise allocated and reserved memory information of the model --- #</span>
            <span class="c1"># turn bytes into MB，</span>
            <span class="c1"># memory_allocated = int(torch.cuda.memory_allocated(gpu) * (10 ** (-6)))</span>
            <span class="c1"># memory_reserved = int(torch.cuda.memory_reserved(gpu) * (10 ** (-6)))</span>
            <span class="c1"># epoch_message += f&quot;GPU rank no.{rank} (cuda:{gpu}): &quot; \</span>
            <span class="c1">#                  f&quot;allocated memory {memory_allocated} MB, &quot; \</span>
            <span class="c1">#                  f&quot;reserved memory {memory_reserved} MB -- &quot;</span>
            <span class="c1"># self.epoch_records[&#39;consumed_memory&#39;][f&#39;Rank{rank}&#39;][&#39;memory_allocated&#39;].append(memory_allocated)</span>
            <span class="c1"># self.epoch_records[&#39;consumed_memory&#39;][f&#39;Rank{rank}&#39;][&#39;memory_reserved&#39;].append(memory_reserved)</span>

            <span class="c1"># --- GPUtil can load the information of all the GPUs no matter the rank of the current process --- #</span>
            <span class="c1"># --- but it sometimes fails to report anything because of some IO errors --- #</span>
            <span class="c1"># --- and the returned used memory is the overall memory consumption of the GPU, --- #</span>
            <span class="c1"># --- which means that if there are more than one jobs running on the same GPU, --- #</span>
            <span class="c1"># --- the used memory is not precise for the current job. --- #</span>
            <span class="n">memory_used</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># for local GPU ID</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gpu</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">):</span>
                <span class="n">memory_used</span> <span class="o">=</span> <span class="n">gpus</span><span class="p">[</span><span class="n">gpu</span><span class="p">]</span><span class="o">.</span><span class="n">memoryUsed</span>
                <span class="n">gpu_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="n">gpu</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># for GPU UUID</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">curr_gpu</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">gpu</span><span class="p">:</span>
                        <span class="n">curr_gpu</span> <span class="o">=</span> <span class="n">g</span>
                <span class="k">if</span> <span class="n">curr_gpu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">memory_used</span> <span class="o">=</span> <span class="n">curr_gpu</span><span class="o">.</span><span class="n">memoryUsed</span>
                <span class="n">gpu_name</span> <span class="o">=</span> <span class="n">gpu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected errors happen when retrieving GPU IDs. (got </span><span class="si">{</span><span class="n">gpu</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="c1"># if some unexpected errors happen above, memory_used will remain 0</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;GPU rank no.</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">gpu_name</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">memory_used</span><span class="si">}</span><span class="s2"> MB -- &quot;</span>

            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_used</span><span class="p">)</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">epoch_message</span>

    <span class="k">def</span> <span class="nf">record_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records criteria in each epoch during training or evaluation.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch_message (str):</span>
<span class="sd">                String to be included in the epoch message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The updated epoch message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- Criteria information -- </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># Loop through all training criteria and record average and standard deviation</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># calculate the average criterion value</span>
            <span class="n">aver_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">std_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Average </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">aver_result</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">std_result</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># record the average criterion value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aver_result</span><span class="p">)</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">epoch_message</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method for initializing the monitor.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (str):</span>
<span class="sd">                Command line arguments passed as a Namespace object.</span>
<span class="sd">            kwargs:</span>
<span class="sd">                Additional keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to be called at the start of each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to be called at each step in an epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to be called at the end of each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method currently performs no operation and always returns None.</span>

<span class="sd">        The intention is for subclasses to override this method to return a dictionary</span>
<span class="sd">        containing the state of the Monitor. However, in the base Monitor class,</span>
<span class="sd">        it does not have any state to save, so it returns None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the Monitor state.</span>

<span class="sd">        Args:</span>
<span class="sd">            state_dict (Dict):</span>
<span class="sd">                Dictionary containing a whole state of the Monitor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">result_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the monitor class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>logger</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A logger object for logging messages.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="argparse.Namespace">Namespace</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Command line arguments passed as a Namespace object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>result_path</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the directory where results should be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">result_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the monitor class.</span>

<span class="sd">    Args:</span>
<span class="sd">        logger: A logger object for logging messages.</span>
<span class="sd">        args: Command line arguments passed as a Namespace object.</span>
<span class="sd">        result_path: Path to the directory where results should be saved.</span>
<span class="sd">        **kwargs: Additional keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># Initialize shared members</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">result_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">train_result_path</span>
        <span class="k">if</span> <span class="n">result_path</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">parse_path_args</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gpus</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpus</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpus</span><span class="p">,</span> <span class="n">List</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">gpus</span><span class="p">]</span>

    <span class="c1"># Initialize shared record information</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">consumed_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data_load_time</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_forward_time</span><span class="o">=</span><span class="p">[]),</span>
        <span class="n">consumed_memory</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
        <span class="n">criteria</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="c1"># Add GPU ranks to consumed_memory if they don&#39;t exist</span>
    <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpus</span><span class="p">):</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Initialize step-level records</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">consumed_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data_load_time</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_forward_time</span><span class="o">=</span><span class="p">[]),</span>
        <span class="n">criteria</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">monitor_init</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Initialize snapshooter for log snapshotting</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">snapshot_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">result_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span>
        <span class="n">snap_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
        <span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="n">monitor_snapshot_conf</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Initialize multiprocessing event to enable communication with the snapshooter process</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">Process</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">snapshot_logs</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">snapshot_conf</span><span class="p">),</span>
        <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.empty_queue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">empty_queue</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Checks if the logs queue is empty.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Boolean value indicating whether the logs queue is empty or not.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">empty_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the logs queue is empty.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Boolean value indicating whether the logs queue is empty or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.enqueue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">enqueue</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Enqueues logs into the logs_queue.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>logs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span> or <span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary or list of dictionaries containing logs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="n">Dict</span> <span class="ow">or</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enqueues logs into the logs_queue.</span>

<span class="sd">    Args:</span>
<span class="sd">        logs:</span>
<span class="sd">            A dictionary or list of dictionaries containing logs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logs_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected logs to be a Dict or a List[Dict].&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.finish_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">finish_epoch</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method to be called at the end of each epoch.</p>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method to be called at the end of each epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.load_state_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Loads the Monitor state.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing a whole state of the Monitor.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the Monitor state.</span>

<span class="sd">    Args:</span>
<span class="sd">        state_dict (Dict):</span>
<span class="sd">            Dictionary containing a whole state of the Monitor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">state_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.measure_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">measure_time</span><span class="p">(</span><span class="n">names</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Context manager for measuring time of execution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>names</code>
            </td>
            <td>
                  <code>str or <span title="typing.List">List</span>[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name or list of names for the operations to be timed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">measure_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager for measuring time of execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        names (str or List[str]):</span>
<span class="sd">            Name or list of names for the operations to be timed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">names</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">,</span> <span class="n">names</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">names</span>
    <span class="p">)</span>
    <span class="n">dict_pointer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_pointer</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dict_pointer</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">dict_pointer</span> <span class="o">=</span> <span class="n">dict_pointer</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">dict_pointer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.monitor_init" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">monitor_init</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method for initializing the monitor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Command line arguments passed as a Namespace object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method for initializing the monitor.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (str):</span>
<span class="sd">            Command line arguments passed as a Namespace object.</span>
<span class="sd">        kwargs:</span>
<span class="sd">            Additional keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.record_consumed_memory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">record_consumed_memory</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Records memory consumed in each epoch during training or evaluation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch_message</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String to be included in the epoch message.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated epoch message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">record_consumed_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records memory consumed in each epoch during training or evaluation.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch_message (str):</span>
<span class="sd">            String to be included in the epoch message.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated epoch message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- Consumed Memory -- </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">GPUtil</span><span class="o">.</span><span class="n">getGPUs</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GPUtil.getGPUs() returns nothing at the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="p">)</span>

    <span class="c1"># Record consumed memory for each GPU</span>
    <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpus</span><span class="p">):</span>
        <span class="c1"># recover the GPU number from &#39;CUDA_VISIBLE_DEVICES&#39;</span>
        <span class="k">if</span> <span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="n">gpu</span><span class="p">]</span>
            <span class="c1"># if gpu is in the form of the local ID, it will be converted into an integer for List indexing</span>
            <span class="k">if</span> <span class="n">gpu</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">gpu</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span>
            <span class="c1"># if gpu is in the form of the UUID, it will be kept as a string</span>

        <span class="c1"># --- torch.cuda is only able to report the GPU used in the current rank --- #</span>
        <span class="c1"># --- but torch.cuda can report the precise allocated and reserved memory information of the model --- #</span>
        <span class="c1"># turn bytes into MB，</span>
        <span class="c1"># memory_allocated = int(torch.cuda.memory_allocated(gpu) * (10 ** (-6)))</span>
        <span class="c1"># memory_reserved = int(torch.cuda.memory_reserved(gpu) * (10 ** (-6)))</span>
        <span class="c1"># epoch_message += f&quot;GPU rank no.{rank} (cuda:{gpu}): &quot; \</span>
        <span class="c1">#                  f&quot;allocated memory {memory_allocated} MB, &quot; \</span>
        <span class="c1">#                  f&quot;reserved memory {memory_reserved} MB -- &quot;</span>
        <span class="c1"># self.epoch_records[&#39;consumed_memory&#39;][f&#39;Rank{rank}&#39;][&#39;memory_allocated&#39;].append(memory_allocated)</span>
        <span class="c1"># self.epoch_records[&#39;consumed_memory&#39;][f&#39;Rank{rank}&#39;][&#39;memory_reserved&#39;].append(memory_reserved)</span>

        <span class="c1"># --- GPUtil can load the information of all the GPUs no matter the rank of the current process --- #</span>
        <span class="c1"># --- but it sometimes fails to report anything because of some IO errors --- #</span>
        <span class="c1"># --- and the returned used memory is the overall memory consumption of the GPU, --- #</span>
        <span class="c1"># --- which means that if there are more than one jobs running on the same GPU, --- #</span>
        <span class="c1"># --- the used memory is not precise for the current job. --- #</span>
        <span class="n">memory_used</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># for local GPU ID</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gpu</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">):</span>
            <span class="n">memory_used</span> <span class="o">=</span> <span class="n">gpus</span><span class="p">[</span><span class="n">gpu</span><span class="p">]</span><span class="o">.</span><span class="n">memoryUsed</span>
            <span class="n">gpu_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="n">gpu</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># for GPU UUID</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">curr_gpu</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">gpu</span><span class="p">:</span>
                    <span class="n">curr_gpu</span> <span class="o">=</span> <span class="n">g</span>
            <span class="k">if</span> <span class="n">curr_gpu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">memory_used</span> <span class="o">=</span> <span class="n">curr_gpu</span><span class="o">.</span><span class="n">memoryUsed</span>
            <span class="n">gpu_name</span> <span class="o">=</span> <span class="n">gpu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected errors happen when retrieving GPU IDs. (got </span><span class="si">{</span><span class="n">gpu</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="c1"># if some unexpected errors happen above, memory_used will remain 0</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;GPU rank no.</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">gpu_name</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">memory_used</span><span class="si">}</span><span class="s2"> MB -- &quot;</span>

        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_memory&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_used</span><span class="p">)</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">epoch_message</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.record_consumed_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">record_consumed_time</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Records time consumed in each epoch during training or evaluation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch_message</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String to be included in the epoch message.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated epoch message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">record_consumed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records time consumed in each epoch during training or evaluation.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch_message (str):</span>
<span class="sd">            String to be included in the epoch message.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated epoch message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- Consumed Time -- </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># Record data loading time</span>
    <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;data_load_time&quot;</span><span class="p">])</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total data load time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;data_load_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>

    <span class="c1"># Record model forward time</span>
    <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;model_forward_time&quot;</span><span class="p">])</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total model forward time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;model_forward_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">epoch_message</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.record_criteria" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">record_criteria</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Records criteria in each epoch during training or evaluation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch_message</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String to be included in the epoch message.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated epoch message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">record_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records criteria in each epoch during training or evaluation.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch_message (str):</span>
<span class="sd">            String to be included in the epoch message.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated epoch message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- Criteria information -- </span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># Loop through all training criteria and record average and standard deviation</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># calculate the average criterion value</span>
        <span class="n">aver_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">std_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Average </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">aver_result</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">std_result</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="c1"># record the average criterion value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aver_result</span><span class="p">)</span>
    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">epoch_message</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.record_step_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">record_step_info</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">step_info</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Records information at each step during training or evaluation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key under which information should be recorded.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>step_info</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the information to be recorded.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">record_step_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">step_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records information at each step during training or evaluation.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str):</span>
<span class="sd">            Key under which information should be recorded.</span>
<span class="sd">        step_info (Dict):</span>
<span class="sd">            Dictionary containing the information to be recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># result is in the form of torch.Tensor, so it needs to be transformed by .item()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.refresh_step_records" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">refresh_step_records</span><span class="p">(</span><span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Refreshes the step records by resetting the values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>records</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the records to be refreshed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">refresh_step_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refreshes the step records by resetting the values.</span>

<span class="sd">    Args:</span>
<span class="sd">        records (Dict, optional):</span>
<span class="sd">            A dictionary containing the records to be refreshed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refresh_step_records</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">List</span><span class="p">):</span>
                <span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected type in records: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected records to be of type Dict.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.start_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_epoch</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method to be called at the start of each epoch.</p>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method to be called at the start of each epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.state_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">state_dict</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>This method currently performs no operation and always returns None.</p>
<p>The intention is for subclasses to override this method to return a dictionary
containing the state of the Monitor. However, in the base Monitor class,
it does not have any state to save, so it returns None.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method currently performs no operation and always returns None.</span>

<span class="sd">    The intention is for subclasses to override this method to return a dictionary</span>
<span class="sd">    containing the state of the Monitor. However, in the base Monitor class,</span>
<span class="sd">    it does not have any state to save, so it returns None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.Monitor.step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">step</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method to be called at each step in an epoch.</p>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method to be called at each step in an epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="monitor.TestMonitor" class="doc doc-heading">
            <code>TestMonitor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="monitor.Monitor" href="#monitor.Monitor">Monitor</a></code></p>


        <p>Class responsible for monitoring the testing process and logging real-time information.
It extends the base Monitor class.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.distributed">distributed</span></code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, indicates distributed training.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.report_per_steps">report_per_steps</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frequency of reporting in steps.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.bad_cases_selection">bad_cases_selection</span></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Criteria for selecting bad cases, if any.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.data_saving_logs_queue">data_saving_logs_queue</span></code></td>
            <td>
                  <code><span title="multiprocessing.Queue">Queue</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Queue object for storing logs to be saved.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.prev_test_time">prev_test_time</span></code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time of the previous test, used to calculate elapsed time.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.total_step_num">total_step_num</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of steps in the test.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.step_info">step_info</span></code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about the current test step.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TestMonitor.finished_group_num">finished_group_num</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of groups that have finished testing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>speechain/monitor.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TestMonitor</span><span class="p">(</span><span class="n">Monitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class responsible for monitoring the testing process and logging real-time information.</span>
<span class="sd">    It extends the base Monitor class.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        distributed (bool):</span>
<span class="sd">            If True, indicates distributed training.</span>
<span class="sd">        report_per_steps (int):</span>
<span class="sd">            Frequency of reporting in steps.</span>
<span class="sd">        bad_cases_selection (List[List]):</span>
<span class="sd">            Criteria for selecting bad cases, if any.</span>
<span class="sd">        data_saving_logs_queue (Queue):</span>
<span class="sd">            Queue object for storing logs to be saved.</span>
<span class="sd">        prev_test_time (float):</span>
<span class="sd">            Time of the previous test, used to calculate elapsed time.</span>
<span class="sd">        total_step_num (int):</span>
<span class="sd">            Total number of steps in the test.</span>
<span class="sd">        step_info (dict):</span>
<span class="sd">            Information about the current test step.</span>
<span class="sd">        finished_group_num (int):</span>
<span class="sd">            Number of groups that have finished testing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the TestMonitor with the given arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (argparse.Namespace):</span>
<span class="sd">                Parsed command line arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distributed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">distributed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">report_per_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">bad_cases_selection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">List</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span><span class="p">]</span>

        <span class="c1"># initialize the snapshooter of the monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="c1"># create daemon processes for data saving</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">saving_proc_num</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;&#39;saving_proc_num&#39; should be an integer larger than 1!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saving_proc_num</span>
        <span class="k">for</span> <span class="n">proc_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span><span class="p">):</span>
            <span class="n">Process</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">data_saving_logs</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">proc_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="p">),</span>
                <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a new testing epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            total_step_num (int): Total number of steps in the epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># para init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_test_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_step_num</span> <span class="o">=</span> <span class="n">total_step_num</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;step_info&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">group_time</span><span class="o">=</span><span class="p">[],</span> <span class="n">total_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;finished_group_num&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">test_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">test_index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a single test step and logs the results.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_num (int): Current step number.</span>
<span class="sd">            test_results (Dict[str, Dict]): Results of the test step.</span>
<span class="sd">            test_index (List[str]): Indexes of the tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- Write the testing results of the current step to the testing files --- #</span>
        <span class="c1"># loop each result list in the returned Dict</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">test_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># for .txt file, register the result contents into self.step_info. text data doesn&#39;t occupy too much memory</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]]</span>

                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">test_index</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]):</span>
                    <span class="c1"># for the List-type element, turn it into its string format</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

            <span class="c1"># for other files, data needs to be saved to the disk in real time to reduce the memory burden</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we enqueue a whole batch of data to be saved in order to reduce the number of query operations of each daemon process</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">file_format</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                        <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                        <span class="n">file_name_list</span><span class="o">=</span><span class="n">test_index</span><span class="p">,</span>
                        <span class="n">file_content_list</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span>
                        <span class="n">group_ids</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;group_ids&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s2">&quot;group_ids&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">),</span>
                        <span class="n">sample_rate</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sample_rate&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s2">&quot;sample_rate&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># monitor the approximate size of the queue to be more memory-friendly</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There has been more than </span><span class="si">{</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span><span class="si">}</span><span class="s2"> batches in data_saving_logs_queue, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;so the data generation is paused for 30 seconds.&quot;</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># --- Report the testing midway information to users --- #</span>
        <span class="n">test_step_message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># record the tesing time of the current step</span>
        <span class="n">curr_test_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;group_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_test_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_test_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_test_time</span> <span class="o">=</span> <span class="n">curr_test_time</span>

        <span class="c1"># meet the reporting interval</span>
        <span class="k">if</span> <span class="n">step_num</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">curr_group_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;group_time&quot;</span><span class="p">])</span>

            <span class="c1"># the first testing step</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prev_group_time</span> <span class="o">=</span> <span class="n">curr_group_time</span>
            <span class="c1"># other testing steps</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># calculate the average time of all the previous groups</span>
                <span class="n">prev_group_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span>

            <span class="c1"># calculate the number of remaining steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">finish_step_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span><span class="p">)</span>
            <span class="n">remaining_step_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_step_num</span> <span class="o">-</span> <span class="n">finish_step_num</span>
            <span class="c1"># take the weighted average consuming time of each group</span>
            <span class="n">aver_group_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_group_time</span> <span class="o">+</span> <span class="n">curr_group_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">aver_group_time</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">remaining_step_num</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span>
            <span class="p">)</span>

            <span class="c1"># update the time records</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">curr_group_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;group_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">test_step_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Testing Midway Report -- &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;testing time for the recent </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span><span class="si">}</span><span class="s2"> steps: </span><span class="si">{</span><span class="n">curr_group_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;finished step number: </span><span class="si">{</span><span class="n">finish_step_num</span><span class="si">}</span><span class="s2"> -- &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;remaining step number: </span><span class="si">{</span><span class="n">remaining_step_num</span><span class="si">}</span><span class="s2"> -- &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;expected remaining time: &quot;</span>
            <span class="p">)</span>

            <span class="n">remaining_days</span><span class="p">,</span> <span class="n">remaining_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">remaining_time</span> <span class="o">//</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
            <span class="p">),</span> <span class="n">remaining_time</span> <span class="o">%</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_days</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">d &quot;</span>

            <span class="n">remaining_hours</span><span class="p">,</span> <span class="n">remaining_time</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">remaining_time</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">),</span>
                <span class="n">remaining_time</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining_hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_hours</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">h &quot;</span>

            <span class="n">remaining_minutes</span><span class="p">,</span> <span class="n">remaining_time</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">remaining_time</span> <span class="o">//</span> <span class="mi">60</span><span class="p">),</span>
                <span class="n">remaining_time</span> <span class="o">%</span> <span class="mi">60</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining_minutes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_minutes</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">m &quot;</span>

            <span class="n">remaining_seconds</span> <span class="o">=</span> <span class="n">remaining_time</span>
            <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_seconds</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>

        <span class="k">if</span> <span class="n">test_step_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">test_step_message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait_empty_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits until the log queue is empty before continuing.</span>

<span class="sd">        Args:</span>
<span class="sd">            sleep_time (int, optional): Time to wait in seconds when the queue is not empty. Defaults to 60.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="c1"># wait for one more time when the queue becomes empty to left enough time for data saving</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The data saving process is still working. Waiting for </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds.&quot;</span>
                <span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="c1"># If using distributed training, synchronize all processes before continuing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_info</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method completes various tasks at the end of each epoch, such as:</span>
<span class="sd">        - Gathering checkpoint information from all GPU processes</span>
<span class="sd">        - Generating data path files</span>
<span class="sd">        - Producing evaluation reports for overall and group-level performance</span>
<span class="sd">        - Presenting top-N bad cases (if &#39;instance_reports.md&#39; is in self.step_info)</span>
<span class="sd">        - Plotting histograms for numerical metrics in step_info</span>

<span class="sd">        Arguments:</span>
<span class="sd">            meta_info (Dict, optional):</span>
<span class="sd">                Meta information about testing samples. Used for group-level evaluation.</span>

<span class="sd">        Note:</span>
<span class="sd">            The method is designed for a distributed setting, where results from different processes need to be gathered.</span>
<span class="sd">            If the program is not running in a distributed setting, some steps (like gathering checkpoint information) will be skipped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># group all the testing samples by their meta info</span>
        <span class="n">group_meta_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">meta_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_meta_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="c1"># loop each type of meta data</span>
            <span class="k">for</span> <span class="n">meta_type</span><span class="p">,</span> <span class="n">meta_dict</span> <span class="ow">in</span> <span class="n">meta_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">meta_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_meta_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># loop each group of samples</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">][</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">][</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># --- Gather the checkpoint information of all the processes --- #</span>
        <span class="c1"># load the checkpoint of rank0 and delete testing time information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;rank0_tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint.pth&quot;</span><span class="p">))[</span>
                <span class="s2">&quot;monitor&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group_time&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;total_time&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()):</span>
                <span class="n">_tmp_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint.pth&quot;</span><span class="p">)</span>
                <span class="p">)[</span><span class="s2">&quot;monitor&quot;</span><span class="p">][</span><span class="s2">&quot;step_info&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_tmp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="c1"># make sure that all the samples are sorted by their indices</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="c1"># .md files remain their original names</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.md&quot;</span><span class="p">):</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># normal .txt files have the prefix &#39;idx2&#39; attached at the beginning of their names</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;idx2</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># --- Gather all the save-during-testing files &amp; Generate their path files --- #</span>
        <span class="c1"># generate the data path files</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">):</span>
            <span class="c1"># only consider folders</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="c1"># only consider the folders not named as &#39;figures&#39; and &#39;rank_tmp&#39;</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">file_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;figures&quot;</span>
                <span class="ow">or</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">file_name</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">idx2path</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">search_file_in_subfolder</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                <span class="n">tgt_match_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">data_index</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># add new file into the Dict</span>
                <span class="k">if</span> <span class="n">data_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx2path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_file</span>
                <span class="c1"># for multiple files with the same index (probably because of the non-reproducible resuming issue)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># same the latest file</span>
                    <span class="k">if</span> <span class="n">get_file_birthtime</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">get_file_birthtime</span><span class="p">(</span>
                        <span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">])</span>
                        <span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_file</span>

            <span class="n">idx2path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">idx2path</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;idx2</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">idx2path</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># --- Group-level Evaluation Report Production --- #</span>
        <span class="n">result_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;overall_results.md&quot;</span><span class="p">)</span>
        <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># The overall evaluation performance</span>
        <span class="n">result_string</span> <span class="o">+=</span> <span class="s2">&quot;# Overall Evaluation (mean ± std):</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">content_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># loop each metric and record the overall model performance</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">result_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="c1"># only average the numerical results</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="n">content_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">result_string</span> <span class="o">+=</span> <span class="n">get_list_strings</span><span class="p">(</span><span class="n">content_dict</span><span class="o">=</span><span class="n">content_dict</span><span class="p">)</span>

        <span class="c1"># record the group-level model performance</span>
        <span class="k">if</span> <span class="n">group_meta_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">group_dict</span> <span class="ow">in</span> <span class="n">group_meta_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">result_string</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">meta_name</span><span class="si">}</span><span class="s2">-wise Evaluation:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(***bold&amp;italic*** numbers represent the maximal ones in all groups while &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;**bold** numbers represent the minimal ones.)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">table_headers</span><span class="p">,</span> <span class="n">table_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_name</span><span class="p">],</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="c1"># loop each group and calculate the group-specific performance</span>
                <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_list</span> <span class="ow">in</span> <span class="n">group_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># loop each metric</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">result_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">result_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">group_list</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="p">]</span>
                        <span class="c1"># skip the non-numerical results</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                            <span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="c1"># average the numerical results and record them</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># create group item lazily</span>
                            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_contents</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">table_contents</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_headers</span><span class="p">:</span>
                                <span class="n">table_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                            <span class="n">table_contents</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">result_list</span><span class="p">))</span>

                <span class="c1"># get the max and min group value for each numerical metric</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table_headers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">metric_value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">table_contents</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                    <span class="n">max_value</span><span class="p">,</span> <span class="n">min_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">metric_value_list</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">metric_value_list</span>
                    <span class="p">)</span>
                    <span class="c1"># loop each group</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">table_contents</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># turn the max number into a bold&amp;italic string</span>
                        <span class="k">if</span> <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_value</span><span class="p">:</span>
                            <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                                <span class="n">i</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;***</span><span class="si">{</span><span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">***&quot;</span>
                        <span class="c1"># turn the min number into a bold string</span>
                        <span class="k">elif</span> <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">min_value</span><span class="p">:</span>
                            <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                                <span class="n">i</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;**</span><span class="si">{</span><span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">**&quot;</span>
                        <span class="c1"># turn other numbers into pure strings</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1"># attach the list of the current group into the result string</span>
                <span class="n">result_string</span> <span class="o">+=</span> <span class="n">get_table_strings</span><span class="p">(</span>
                    <span class="n">contents</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">table_contents</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                    <span class="n">first_col</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">table_contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">table_headers</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="p">[</span><span class="n">result_string</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Top-N Bad Cases Presentation --- #</span>
        <span class="c1"># only present topn bad cases if instance_reports.md is given</span>
        <span class="k">if</span> <span class="s2">&quot;instance_reports.md&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># loop each tri-tuple</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span><span class="p">:</span>
                <span class="n">result_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;top</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">.md&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># get the indices of the topn samples</span>
                    <span class="n">selected_samples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">)[:</span><span class="n">num</span><span class="p">]</span>
                    <span class="n">selected_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selected_samples</span><span class="p">]</span>

                    <span class="c1"># make the .md string for all the top-n bad samples</span>
                    <span class="n">sample_reports</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">s_index</span> <span class="ow">in</span> <span class="n">selected_samples</span><span class="p">:</span>
                        <span class="n">sample_reports</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;**</span><span class="si">{</span><span class="n">s_index</span><span class="si">}</span><span class="s2">**&quot;</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;instance_reports.md&quot;</span><span class="p">][</span><span class="n">s_index</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="p">[</span><span class="n">sample_reports</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Histograms Plotting --- #</span>
        <span class="c1"># remove the old figures if have</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;figures&quot;</span><span class="p">)):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;figures&quot;</span><span class="p">))</span>

        <span class="c1"># loop each metric and plot the histogram figure</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">result_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="c1"># only consider the numerical results</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">materials</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">({</span><span class="n">metric</span><span class="p">:</span> <span class="n">result_list</span><span class="p">}),</span> <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;The snapshooter is still snapshotting. Waiting for 10 seconds.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the state of the TestMonitor instance. This is useful for checkpointing or logging purposes.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - A dictionary that includes:</span>
<span class="sd">            * step_info: A dictionary storing information about each step.</span>
<span class="sd">            * finished_group_num: The number of groups that have finished processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">step_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">,</span> <span class="n">finished_group_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="monitor.TestMonitor.finish_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">finish_epoch</span><span class="p">(</span><span class="n">meta_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This method completes various tasks at the end of each epoch, such as:
- Gathering checkpoint information from all GPU processes
- Generating data path files
- Producing evaluation reports for overall and group-level performance
- Presenting top-N bad cases (if 'instance_reports.md' is in self.step_info)
- Plotting histograms for numerical metrics in step_info</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>meta_info</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Meta information about testing samples. Used for group-level evaluation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The method is designed for a distributed setting, where results from different processes need to be gathered.
If the program is not running in a distributed setting, some steps (like gathering checkpoint information) will be skipped.</p>
</details>
            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_info</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method completes various tasks at the end of each epoch, such as:</span>
<span class="sd">    - Gathering checkpoint information from all GPU processes</span>
<span class="sd">    - Generating data path files</span>
<span class="sd">    - Producing evaluation reports for overall and group-level performance</span>
<span class="sd">    - Presenting top-N bad cases (if &#39;instance_reports.md&#39; is in self.step_info)</span>
<span class="sd">    - Plotting histograms for numerical metrics in step_info</span>

<span class="sd">    Arguments:</span>
<span class="sd">        meta_info (Dict, optional):</span>
<span class="sd">            Meta information about testing samples. Used for group-level evaluation.</span>

<span class="sd">    Note:</span>
<span class="sd">        The method is designed for a distributed setting, where results from different processes need to be gathered.</span>
<span class="sd">        If the program is not running in a distributed setting, some steps (like gathering checkpoint information) will be skipped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># group all the testing samples by their meta info</span>
    <span class="n">group_meta_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">meta_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">group_meta_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># loop each type of meta data</span>
        <span class="k">for</span> <span class="n">meta_type</span><span class="p">,</span> <span class="n">meta_dict</span> <span class="ow">in</span> <span class="n">meta_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">meta_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_meta_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="c1"># loop each group of samples</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">][</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">group_meta_info</span><span class="p">[</span><span class="n">meta_type</span><span class="p">][</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># --- Gather the checkpoint information of all the processes --- #</span>
    <span class="c1"># load the checkpoint of rank0 and delete testing time information</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;rank0_tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint.pth&quot;</span><span class="p">))[</span>
            <span class="s2">&quot;monitor&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group_time&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;total_time&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()):</span>
            <span class="n">_tmp_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;rank</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint.pth&quot;</span><span class="p">)</span>
            <span class="p">)[</span><span class="s2">&quot;monitor&quot;</span><span class="p">][</span><span class="s2">&quot;step_info&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_tmp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="c1"># make sure that all the samples are sorted by their indices</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># .md files remain their original names</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.md&quot;</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># normal .txt files have the prefix &#39;idx2&#39; attached at the beginning of their names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;idx2</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># --- Gather all the save-during-testing files &amp; Generate their path files --- #</span>
    <span class="c1"># generate the data path files</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">):</span>
        <span class="c1"># only consider folders</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="c1"># only consider the folders not named as &#39;figures&#39; and &#39;rank_tmp&#39;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">file_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;figures&quot;</span>
            <span class="ow">or</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">file_name</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">idx2path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">search_file_in_subfolder</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
            <span class="n">tgt_match_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">data_index</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># add new file into the Dict</span>
            <span class="k">if</span> <span class="n">data_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx2path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_file</span>
            <span class="c1"># for multiple files with the same index (probably because of the non-reproducible resuming issue)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># same the latest file</span>
                <span class="k">if</span> <span class="n">get_file_birthtime</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">get_file_birthtime</span><span class="p">(</span>
                    <span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">])</span>
                    <span class="n">idx2path</span><span class="p">[</span><span class="n">data_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_file</span>

        <span class="n">idx2path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">idx2path</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;idx2</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">idx2path</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># --- Group-level Evaluation Report Production --- #</span>
    <span class="n">result_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;overall_results.md&quot;</span><span class="p">)</span>
    <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># The overall evaluation performance</span>
    <span class="n">result_string</span> <span class="o">+=</span> <span class="s2">&quot;# Overall Evaluation (mean ± std):</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">content_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># loop each metric and record the overall model performance</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">result_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># only average the numerical results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">continue</span>

        <span class="n">content_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">result_string</span> <span class="o">+=</span> <span class="n">get_list_strings</span><span class="p">(</span><span class="n">content_dict</span><span class="o">=</span><span class="n">content_dict</span><span class="p">)</span>

    <span class="c1"># record the group-level model performance</span>
    <span class="k">if</span> <span class="n">group_meta_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">group_dict</span> <span class="ow">in</span> <span class="n">group_meta_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result_string</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">meta_name</span><span class="si">}</span><span class="s2">-wise Evaluation:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(***bold&amp;italic*** numbers represent the maximal ones in all groups while &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;**bold** numbers represent the minimal ones.)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">table_headers</span><span class="p">,</span> <span class="n">table_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_name</span><span class="p">],</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="c1"># loop each group and calculate the group-specific performance</span>
            <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_list</span> <span class="ow">in</span> <span class="n">group_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># loop each metric</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">result_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">result_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">group_list</span>
                        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">]</span>
                    <span class="c1"># skip the non-numerical results</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c1"># average the numerical results and record them</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># create group item lazily</span>
                        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_contents</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">table_contents</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_headers</span><span class="p">:</span>
                            <span class="n">table_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                        <span class="n">table_contents</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">result_list</span><span class="p">))</span>

            <span class="c1"># get the max and min group value for each numerical metric</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table_headers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">metric_value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">table_contents</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="n">max_value</span><span class="p">,</span> <span class="n">min_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">metric_value_list</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">metric_value_list</span>
                <span class="p">)</span>
                <span class="c1"># loop each group</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">table_contents</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># turn the max number into a bold&amp;italic string</span>
                    <span class="k">if</span> <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_value</span><span class="p">:</span>
                        <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                            <span class="n">i</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;***</span><span class="si">{</span><span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">***&quot;</span>
                    <span class="c1"># turn the min number into a bold string</span>
                    <span class="k">elif</span> <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">min_value</span><span class="p">:</span>
                        <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                            <span class="n">i</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;**</span><span class="si">{</span><span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">**&quot;</span>
                    <span class="c1"># turn other numbers into pure strings</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_contents</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># attach the list of the current group into the result string</span>
            <span class="n">result_string</span> <span class="o">+=</span> <span class="n">get_table_strings</span><span class="p">(</span>
                <span class="n">contents</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">table_contents</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="n">first_col</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">table_contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">table_headers</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="p">[</span><span class="n">result_string</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Top-N Bad Cases Presentation --- #</span>
    <span class="c1"># only present topn bad cases if instance_reports.md is given</span>
    <span class="k">if</span> <span class="s2">&quot;instance_reports.md&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># loop each tri-tuple</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span><span class="p">:</span>
            <span class="n">result_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;top</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">.md&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># get the indices of the topn samples</span>
                <span class="n">selected_samples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">)[:</span><span class="n">num</span><span class="p">]</span>
                <span class="n">selected_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selected_samples</span><span class="p">]</span>

                <span class="c1"># make the .md string for all the top-n bad samples</span>
                <span class="n">sample_reports</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">s_index</span> <span class="ow">in</span> <span class="n">selected_samples</span><span class="p">:</span>
                    <span class="n">sample_reports</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;**</span><span class="si">{</span><span class="n">s_index</span><span class="si">}</span><span class="s2">**&quot;</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;instance_reports.md&quot;</span><span class="p">][</span><span class="n">s_index</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="p">[</span><span class="n">sample_reports</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Histograms Plotting --- #</span>
    <span class="c1"># remove the old figures if have</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;figures&quot;</span><span class="p">)):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;figures&quot;</span><span class="p">))</span>

    <span class="c1"># loop each metric and plot the histogram figure</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">result_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># only consider the numerical results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">continue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">materials</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">({</span><span class="n">metric</span><span class="p">:</span> <span class="n">result_list</span><span class="p">}),</span> <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;The snapshooter is still snapshotting. Waiting for 10 seconds.&quot;</span>
                <span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TestMonitor.monitor_init" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">monitor_init</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the TestMonitor with the given arguments.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="argparse.Namespace">Namespace</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parsed command line arguments.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the TestMonitor with the given arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (argparse.Namespace):</span>
<span class="sd">            Parsed command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distributed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">distributed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">report_per_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">bad_cases_selection</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_cases_selection</span><span class="p">]</span>

    <span class="c1"># initialize the snapshooter of the monitor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="c1"># create daemon processes for data saving</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">saving_proc_num</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="p">),</span> <span class="s2">&quot;&#39;saving_proc_num&#39; should be an integer larger than 1!&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saving_proc_num</span>
    <span class="k">for</span> <span class="n">proc_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span><span class="p">):</span>
        <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">data_saving_logs</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">proc_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="p">),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TestMonitor.start_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_epoch</span><span class="p">(</span><span class="n">total_step_num</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Starts a new testing epoch.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>total_step_num</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of steps in the epoch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a new testing epoch.</span>

<span class="sd">    Args:</span>
<span class="sd">        total_step_num (int): Total number of steps in the epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># para init</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prev_test_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">total_step_num</span> <span class="o">=</span> <span class="n">total_step_num</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;step_info&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">group_time</span><span class="o">=</span><span class="p">[],</span> <span class="n">total_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;finished_group_num&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TestMonitor.state_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">state_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the state of the TestMonitor instance. This is useful for checkpointing or logging purposes.</p>
        <ul>
<li>A dictionary that includes:<ul>
<li>step_info: A dictionary storing information about each step.</li>
<li>finished_group_num: The number of groups that have finished processing.</li>
</ul>
</li>
</ul>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the state of the TestMonitor instance. This is useful for checkpointing or logging purposes.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - A dictionary that includes:</span>
<span class="sd">        * step_info: A dictionary storing information about each step.</span>
<span class="sd">        * finished_group_num: The number of groups that have finished processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">step_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">,</span> <span class="n">finished_group_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TestMonitor.step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">step</span><span class="p">(</span><span class="n">step_num</span><span class="p">,</span> <span class="n">test_results</span><span class="p">,</span> <span class="n">test_index</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Executes a single test step and logs the results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>step_num</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current step number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_results</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Results of the test step.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_index</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indexes of the tests.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">test_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">test_index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes a single test step and logs the results.</span>

<span class="sd">    Args:</span>
<span class="sd">        step_num (int): Current step number.</span>
<span class="sd">        test_results (Dict[str, Dict]): Results of the test step.</span>
<span class="sd">        test_index (List[str]): Indexes of the tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- Write the testing results of the current step to the testing files --- #</span>
    <span class="c1"># loop each result list in the returned Dict</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">test_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># for .txt file, register the result contents into self.step_info. text data doesn&#39;t occupy too much memory</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">test_index</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]):</span>
                <span class="c1"># for the List-type element, turn it into its string format</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

        <span class="c1"># for other files, data needs to be saved to the disk in real time to reduce the memory burden</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we enqueue a whole batch of data to be saved in order to reduce the number of query operations of each daemon process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">file_format</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                    <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                    <span class="n">file_name_list</span><span class="o">=</span><span class="n">test_index</span><span class="p">,</span>
                    <span class="n">file_content_list</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span>
                    <span class="n">group_ids</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;group_ids&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;group_ids&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="n">sample_rate</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sample_rate&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;sample_rate&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># monitor the approximate size of the queue to be more memory-friendly</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There has been more than </span><span class="si">{</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">saving_proc_num</span><span class="si">}</span><span class="s2"> batches in data_saving_logs_queue, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;so the data generation is paused for 30 seconds.&quot;</span>
        <span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

    <span class="c1"># --- Report the testing midway information to users --- #</span>
    <span class="n">test_step_message</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># record the tesing time of the current step</span>
    <span class="n">curr_test_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;group_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_test_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_test_time</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prev_test_time</span> <span class="o">=</span> <span class="n">curr_test_time</span>

    <span class="c1"># meet the reporting interval</span>
    <span class="k">if</span> <span class="n">step_num</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">curr_group_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;group_time&quot;</span><span class="p">])</span>

        <span class="c1"># the first testing step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prev_group_time</span> <span class="o">=</span> <span class="n">curr_group_time</span>
        <span class="c1"># other testing steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate the average time of all the previous groups</span>
            <span class="n">prev_group_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span>

        <span class="c1"># calculate the number of remaining steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">finish_step_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_group_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span><span class="p">)</span>
        <span class="n">remaining_step_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_step_num</span> <span class="o">-</span> <span class="n">finish_step_num</span>
        <span class="c1"># take the weighted average consuming time of each group</span>
        <span class="n">aver_group_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_group_time</span> <span class="o">+</span> <span class="n">curr_group_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">aver_group_time</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">remaining_step_num</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span>
        <span class="p">)</span>

        <span class="c1"># update the time records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">curr_group_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_info</span><span class="p">[</span><span class="s2">&quot;group_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">test_step_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Testing Midway Report -- &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;testing time for the recent </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span><span class="si">}</span><span class="s2"> steps: </span><span class="si">{</span><span class="n">curr_group_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;finished step number: </span><span class="si">{</span><span class="n">finish_step_num</span><span class="si">}</span><span class="s2"> -- &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;remaining step number: </span><span class="si">{</span><span class="n">remaining_step_num</span><span class="si">}</span><span class="s2"> -- &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;expected remaining time: &quot;</span>
        <span class="p">)</span>

        <span class="n">remaining_days</span><span class="p">,</span> <span class="n">remaining_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">remaining_time</span> <span class="o">//</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
        <span class="p">),</span> <span class="n">remaining_time</span> <span class="o">%</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remaining_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_days</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">d &quot;</span>

        <span class="n">remaining_hours</span><span class="p">,</span> <span class="n">remaining_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">remaining_time</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">),</span>
            <span class="n">remaining_time</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">remaining_hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_hours</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">h &quot;</span>

        <span class="n">remaining_minutes</span><span class="p">,</span> <span class="n">remaining_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">remaining_time</span> <span class="o">//</span> <span class="mi">60</span><span class="p">),</span>
            <span class="n">remaining_time</span> <span class="o">%</span> <span class="mi">60</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">remaining_minutes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_minutes</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">m &quot;</span>

        <span class="n">remaining_seconds</span> <span class="o">=</span> <span class="n">remaining_time</span>
        <span class="n">test_step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining_seconds</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>

    <span class="k">if</span> <span class="n">test_step_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">test_step_message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TestMonitor.wait_empty_queues" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wait_empty_queues</span><span class="p">(</span><span class="n">sleep_time</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Waits until the log queue is empty before continuing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sleep_time</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time to wait in seconds when the queue is not empty. Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">wait_empty_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Waits until the log queue is empty before continuing.</span>

<span class="sd">    Args:</span>
<span class="sd">        sleep_time (int, optional): Time to wait in seconds when the queue is not empty. Defaults to 60.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_saving_logs_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="c1"># wait for one more time when the queue becomes empty to left enough time for data saving</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The data saving process is still working. Waiting for </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds.&quot;</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

    <span class="c1"># If using distributed training, synchronize all processes before continuing</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="monitor.TrainMonitor" class="doc doc-heading">
            <code>TrainMonitor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="monitor.Monitor" href="#monitor.Monitor">Monitor</a></code></p>


        <p>The TrainMonitor class extends the Monitor class by adding functionality to track training progress and
performance. It provides methods to initialize monitoring, record metrics at each step and epoch, and store the
state of the training process.</p>






              <details class="quote">
                <summary>Source code in <code>speechain/monitor.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TrainMonitor</span><span class="p">(</span><span class="n">Monitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The TrainMonitor class extends the Monitor class by adding functionality to track training progress and</span>
<span class="sd">    performance. It provides methods to initialize monitoring, record metrics at each step and epoch, and store the</span>
<span class="sd">    state of the training process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the training monitor with the given arguments.</span>
<span class="sd">        This method is responsible for setting up the general members and tracking optimizer information.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (argparse.Namespace):</span>
<span class="sd">                Arguments provided for monitoring.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># general members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">report_per_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">no_optim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span>

        <span class="c1"># training monitor needs to additionally track optimizer information</span>
        <span class="c1"># update epoch-level records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">loss_backward_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">optim_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optim_lr</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
        <span class="c1"># update step-level records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">loss_backward_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">optim_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optim_lr</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the monitor for a new epoch of training.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch (int):</span>
<span class="sd">                The current epoch number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># epoch-level information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># refresh the step-level records at the beginning of each epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_step_records</span><span class="p">()</span>

        <span class="c1"># logging the beginning information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training part of epoch no.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> starts.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">optim_lr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">train_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records information for a single training step.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_num (int):</span>
<span class="sd">                The current step number.</span>
<span class="sd">            optim_lr (Dict[str, float]):</span>
<span class="sd">                The learning rates for each optimizer.</span>
<span class="sd">            train_metrics (Dict[str, torch.Tensor]):</span>
<span class="sd">                The training metrics for the current step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># accumulate the values of training criteria</span>
        <span class="k">if</span> <span class="n">train_metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_step_info</span><span class="p">(</span><span class="s2">&quot;criteria&quot;</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">)</span>

        <span class="c1"># accumulate the optimization times and learning rates of each OptimScheduler</span>
        <span class="k">if</span> <span class="n">optim_lr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_step_info</span><span class="p">(</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">,</span> <span class="n">optim_lr</span><span class="p">)</span>

        <span class="c1"># report all the information for every &#39;report_per_steps&#39; training steps</span>
        <span class="k">if</span> <span class="n">step_num</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># calculate the accumulated time for reporting</span>
            <span class="n">_data_load_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;data_load_time&quot;</span><span class="p">][</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">_model_forward_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;model_forward_time&quot;</span><span class="p">][</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># initialize the returned message of the current step</span>
            <span class="n">step_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Training step no.</span><span class="si">{</span><span class="n">step_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">step_num</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> -- &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data loading time: </span><span class="si">{</span><span class="n">_data_load_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model forward time: </span><span class="si">{</span><span class="n">_model_forward_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="c1"># report the values of criteria in each training step</span>
                <span class="n">step_message</span> <span class="o">+=</span> <span class="s2">&quot;Training Criteria: &quot;</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">_tmp_criteria</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:]</span>
                    <span class="n">step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_tmp_criteria</span><span class="p">)</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> -- &quot;</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span><span class="p">:</span>
                    <span class="c1"># report the information of optimizers after each training step</span>
                    <span class="n">step_message</span> <span class="o">+=</span> <span class="s2">&quot;OptimSchedulers: &quot;</span>
                    <span class="k">for</span> <span class="n">optim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># accumulate the backward and optimization times</span>
                        <span class="n">_loss_backward_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                                <span class="n">optim_name</span>
                            <span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:]</span>
                        <span class="p">)</span>
                        <span class="n">_optim_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span>
                                <span class="n">optim_name</span>
                            <span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:]</span>
                        <span class="p">)</span>
                        <span class="c1"># average the learning rate</span>
                        <span class="n">_lr</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">sum</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">][</span>
                                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span>
                        <span class="p">)</span>

                        <span class="c1"># accumulated optimization time and averaged learning_rates are reported</span>
                        <span class="n">step_message</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">optim_name</span><span class="si">}</span><span class="s2">: &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;loss backward time= </span><span class="si">{</span><span class="n">_loss_backward_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;optimization time=</span><span class="si">{</span><span class="n">_optim_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;learning rate=</span><span class="si">{</span><span class="n">_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> -- &quot;</span>
                        <span class="p">)</span>

            <span class="c1"># logging the information of the current step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">step_message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finishes monitoring for the current epoch, logging information and preparing for the next epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ---- The Information Logging Part ---- #</span>
        <span class="c1"># report the overall consuming time of the current epoch</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The training part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is finished in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Summary of all training steps:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># report the information of the consumed calculation time</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_time</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="c1"># report the information of the consumed GPU memory</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_memory</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="c1"># data loading only</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="c1"># report the information of all the training criteria</span>
            <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_criteria</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

            <span class="c1"># no optimization</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span><span class="p">:</span>
                <span class="c1"># report the information of all the OptimSchedulers</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- OptimScheduler information -- </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># record the optimization information of the current epoch</span>
                <span class="k">for</span> <span class="n">optim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">optim_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">optim_name</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;loss_backward_time&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                            <span class="n">optim_name</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">optim_name</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span>
                            <span class="n">optim_name</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">optim_name</span><span class="si">}</span><span class="s2"> -- &quot;</span>
                    <span class="c1"># accumulate the loss backward time</span>
                    <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                            <span class="n">optim_name</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                        <span class="n">optim_name</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>
                    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total loss backward time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>

                    <span class="c1"># accumulate the optimization time</span>
                    <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span>
                        <span class="n">optim_name</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>
                    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total optimization time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>

                    <span class="c1"># average the learning rate</span>
                    <span class="n">aver_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aver_lr</span><span class="p">)</span>
                    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Average learning rate: </span><span class="si">{</span><span class="n">aver_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># logging the information for the current epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="c1"># ---- The SnapShotting Part ---- #</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># only snapshot the time records in the dry running mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;consumed_time&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># skip the learning rate records in the no optimization mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;optim_lr&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># snapshot the epoch records so for to a curve figure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">materials</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span>
                    <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;curve&quot;</span><span class="p">,</span>
                    <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                    <span class="n">sep_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">subfolder_names</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># notify the snapshooter process of the new queue elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current state of the monitor as a dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The current state of the monitor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">epoch_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="monitor.TrainMonitor.finish_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">finish_epoch</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Finishes monitoring for the current epoch, logging information and preparing for the next epoch.</p>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finishes monitoring for the current epoch, logging information and preparing for the next epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ---- The Information Logging Part ---- #</span>
    <span class="c1"># report the overall consuming time of the current epoch</span>
    <span class="n">epoch_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The training part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is finished in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Summary of all training steps:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># report the information of the consumed calculation time</span>
    <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_time</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

    <span class="c1"># report the information of the consumed GPU memory</span>
    <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_memory</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

    <span class="c1"># data loading only</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="c1"># report the information of all the training criteria</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_criteria</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="c1"># no optimization</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span><span class="p">:</span>
            <span class="c1"># report the information of all the OptimSchedulers</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot; -- OptimScheduler information -- </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># record the optimization information of the current epoch</span>
            <span class="k">for</span> <span class="n">optim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">optim_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">optim_name</span>
                    <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;loss_backward_time&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                        <span class="n">optim_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">optim_name</span>
                    <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span>
                        <span class="n">optim_name</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">optim_name</span><span class="si">}</span><span class="s2"> -- &quot;</span>
                <span class="c1"># accumulate the loss backward time</span>
                <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                        <span class="n">optim_name</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                    <span class="n">optim_name</span>
                <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total loss backward time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>

                <span class="c1"># accumulate the optimization time</span>
                <span class="n">_total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span>
                    <span class="n">optim_name</span>
                <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_total_time</span><span class="p">)</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total optimization time: </span><span class="si">{</span><span class="n">_total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>

                <span class="c1"># average the learning rate</span>
                <span class="n">aver_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aver_lr</span><span class="p">)</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Average learning rate: </span><span class="si">{</span><span class="n">aver_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># logging the information for the current epoch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

    <span class="c1"># ---- The SnapShotting Part ---- #</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># only snapshot the time records in the dry running mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;consumed_time&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># skip the learning rate records in the no optimization mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;optim_lr&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># snapshot the epoch records so for to a curve figure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">materials</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span>
                <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;curve&quot;</span><span class="p">,</span>
                <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                <span class="n">sep_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">subfolder_names</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># notify the snapshooter process of the new queue elements</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainMonitor.monitor_init" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">monitor_init</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the training monitor with the given arguments.
This method is responsible for setting up the general members and tracking optimizer information.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="argparse.Namespace">Namespace</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments provided for monitoring.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the training monitor with the given arguments.</span>
<span class="sd">    This method is responsible for setting up the general members and tracking optimizer information.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (argparse.Namespace):</span>
<span class="sd">            Arguments provided for monitoring.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># general members</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">report_per_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">no_optim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span>

    <span class="c1"># training monitor needs to additionally track optimizer information</span>
    <span class="c1"># update epoch-level records</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">loss_backward_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">optim_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optim_lr</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
    <span class="c1"># update step-level records</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">loss_backward_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">optim_time</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optim_lr</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainMonitor.start_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepares the monitor for a new epoch of training.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current epoch number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the monitor for a new epoch of training.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch (int):</span>
<span class="sd">            The current epoch number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># epoch-level information</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># refresh the step-level records at the beginning of each epoch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_step_records</span><span class="p">()</span>

    <span class="c1"># logging the beginning information</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training part of epoch no.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> starts.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainMonitor.state_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">state_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the current state of the monitor as a dictionary.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the monitor.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the current state of the monitor as a dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The current state of the monitor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">epoch_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainMonitor.step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">step</span><span class="p">(</span><span class="n">step_num</span><span class="p">,</span> <span class="n">optim_lr</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Records information for a single training step.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>step_num</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current step number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>optim_lr</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The learning rates for each optimizer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_metrics</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The training metrics for the current step.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">optim_lr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">train_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records information for a single training step.</span>

<span class="sd">    Args:</span>
<span class="sd">        step_num (int):</span>
<span class="sd">            The current step number.</span>
<span class="sd">        optim_lr (Dict[str, float]):</span>
<span class="sd">            The learning rates for each optimizer.</span>
<span class="sd">        train_metrics (Dict[str, torch.Tensor]):</span>
<span class="sd">            The training metrics for the current step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># accumulate the values of training criteria</span>
    <span class="k">if</span> <span class="n">train_metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_step_info</span><span class="p">(</span><span class="s2">&quot;criteria&quot;</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">)</span>

    <span class="c1"># accumulate the optimization times and learning rates of each OptimScheduler</span>
    <span class="k">if</span> <span class="n">optim_lr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_step_info</span><span class="p">(</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">,</span> <span class="n">optim_lr</span><span class="p">)</span>

    <span class="c1"># report all the information for every &#39;report_per_steps&#39; training steps</span>
    <span class="k">if</span> <span class="n">step_num</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># calculate the accumulated time for reporting</span>
        <span class="n">_data_load_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;data_load_time&quot;</span><span class="p">][</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_model_forward_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;model_forward_time&quot;</span><span class="p">][</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># initialize the returned message of the current step</span>
        <span class="n">step_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Training step no.</span><span class="si">{</span><span class="n">step_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">step_num</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> -- &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;data loading time: </span><span class="si">{</span><span class="n">_data_load_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;model forward time: </span><span class="si">{</span><span class="n">_model_forward_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s -- &quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="c1"># report the values of criteria in each training step</span>
            <span class="n">step_message</span> <span class="o">+=</span> <span class="s2">&quot;Training Criteria: &quot;</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_tmp_criteria</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:]</span>
                <span class="n">step_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_tmp_criteria</span><span class="p">)</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> -- &quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span><span class="p">:</span>
                <span class="c1"># report the information of optimizers after each training step</span>
                <span class="n">step_message</span> <span class="o">+=</span> <span class="s2">&quot;OptimSchedulers: &quot;</span>
                <span class="k">for</span> <span class="n">optim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># accumulate the backward and optimization times</span>
                    <span class="n">_loss_backward_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;loss_backward_time&quot;</span><span class="p">][</span>
                            <span class="n">optim_name</span>
                        <span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="n">_optim_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">][</span><span class="s2">&quot;optim_time&quot;</span><span class="p">][</span>
                            <span class="n">optim_name</span>
                        <span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="c1"># average the learning rate</span>
                    <span class="n">_lr</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">sum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">step_records</span><span class="p">[</span><span class="s2">&quot;optim_lr&quot;</span><span class="p">][</span><span class="n">optim_name</span><span class="p">][</span>
                                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span> <span class="p">:</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                        <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_per_steps</span>
                    <span class="p">)</span>

                    <span class="c1"># accumulated optimization time and averaged learning_rates are reported</span>
                    <span class="n">step_message</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">optim_name</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;loss backward time= </span><span class="si">{</span><span class="n">_loss_backward_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;optimization time=</span><span class="si">{</span><span class="n">_optim_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;learning rate=</span><span class="si">{</span><span class="n">_lr</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> -- &quot;</span>
                    <span class="p">)</span>

        <span class="c1"># logging the information of the current step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">step_message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="monitor.TrainValidMonitor" class="doc doc-heading">
            <code>TrainValidMonitor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>object</code></p>


        <p>A wrapper class for TrainMonitor and ValidMonitor.
The motivations of wrapping TrainMonitor and ValidMonitor together are two-folds:
    1. enable multi-metric best model recording among training and validation metrics.
    2. decouple TrainMonitor and ValidMonitor from Runner to improve cohesion and code readability.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TrainValidMonitor.logger">logger</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger object for logging purposes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TrainValidMonitor.train_monitor">train_monitor</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the TrainMonitor class.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="monitor.TrainValidMonitor.valid_monitor">valid_monitor</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the ValidMonitor class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>speechain/monitor.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TrainValidMonitor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper class for TrainMonitor and ValidMonitor.</span>
<span class="sd">    The motivations of wrapping TrainMonitor and ValidMonitor together are two-folds:</span>
<span class="sd">        1. enable multi-metric best model recording among training and validation metrics.</span>
<span class="sd">        2. decouple TrainMonitor and ValidMonitor from Runner to improve cohesion and code readability.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        logger: Logger object for logging purposes.</span>
<span class="sd">        train_monitor: An instance of the TrainMonitor class.</span>
<span class="sd">        valid_monitor: An instance of the ValidMonitor class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the TrainValidMonitor with a logger, arguments, and a model.</span>

<span class="sd">        Args:</span>
<span class="sd">            logger:</span>
<span class="sd">                Logger object for logging purposes.</span>
<span class="sd">            args:</span>
<span class="sd">                argparse.Namespace object, contains command line arguments.</span>
<span class="sd">            model:</span>
<span class="sd">                Model object, the model to be trained and validated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span> <span class="o">=</span> <span class="n">TrainMonitor</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span> <span class="o">=</span> <span class="n">ValidMonitor</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a new training epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch: The epoch number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">optim_lr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">train_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a training step.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_num: The step number.</span>
<span class="sd">            optim_lr: The learning rate(s) of the optimizer(s).</span>
<span class="sd">            train_metrics: The training metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
            <span class="n">step_num</span><span class="o">=</span><span class="n">step_num</span><span class="p">,</span> <span class="n">optim_lr</span><span class="o">=</span><span class="n">optim_lr</span><span class="p">,</span> <span class="n">train_metrics</span><span class="o">=</span><span class="n">train_metrics</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish_train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finishes a training epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">finish_epoch</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start_valid_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a new validation epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch: The epoch number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">valid_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a validation step.</span>

<span class="sd">        Args:</span>
<span class="sd">            valid_metrics: The validation metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">valid_metrics</span><span class="o">=</span><span class="n">valid_metrics</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">valid_model_snapshot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">used_sample</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a snapshot of the validation model.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch: The epoch number.</span>
<span class="sd">            domain: The domain of validation.</span>
<span class="sd">            sample_index: The sample index.</span>
<span class="sd">            used_sample: The sample used for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">model_snapshot</span><span class="p">(</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">sample_index</span><span class="o">=</span><span class="n">sample_index</span><span class="p">,</span>
            <span class="n">used_sample</span><span class="o">=</span><span class="n">used_sample</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish_valid_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">valid_per_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finishes a validation epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            valid_flag: The validation flag.</span>
<span class="sd">            valid_per_epochs: The number of epochs per validation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result from the finish_epoch method of the ValidMonitor object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">finish_epoch</span><span class="p">(</span>
            <span class="n">train_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">,</span>
            <span class="n">valid_flag</span><span class="o">=</span><span class="n">valid_flag</span><span class="p">,</span>
            <span class="n">valid_per_epochs</span><span class="o">=</span><span class="n">valid_per_epochs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait_empty_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_wait_round</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the snapshot creator processes of train_monitor and valid_monitor are still working.</span>
<span class="sd">        Wait until the material queues of the snapshot creators become empty.</span>

<span class="sd">        Args:</span>
<span class="sd">            sleep_time: The sleep time in seconds between each check. Default is 10 seconds.</span>
<span class="sd">            max_wait_round: The maximum number of waiting rounds. Default is 60 rounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_wait_round</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The training snapshooter is still snapshotting. &quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The validation snapshooter is still snapshotting. &quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds......&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The maximal waiting time </span><span class="si">{</span><span class="n">max_wait_round</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds is reached, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;so the snapshooters will be shut down......&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the state of the TrainMonitor and ValidMonitor in dictionary form.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict:</span>
<span class="sd">                The current state of the TrainMonitor and ValidMonitor, typically including model parameters and</span>
<span class="sd">                other related information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">train_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="n">valid_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the state of the TrainMonitor and ValidMonitor from a dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            state_dict:</span>
<span class="sd">                The dictionary containing the state of the TrainMonitor and ValidMonitor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;train_monitor&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;valid_monitor&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the TrainValidMonitor with a logger, arguments, and a model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>logger</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger object for logging purposes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="argparse.Namespace">Namespace</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>argparse.Namespace object, contains command line arguments.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="speechain.model.abs.Model">Model</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model object, the model to be trained and validated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the TrainValidMonitor with a logger, arguments, and a model.</span>

<span class="sd">    Args:</span>
<span class="sd">        logger:</span>
<span class="sd">            Logger object for logging purposes.</span>
<span class="sd">        args:</span>
<span class="sd">            argparse.Namespace object, contains command line arguments.</span>
<span class="sd">        model:</span>
<span class="sd">            Model object, the model to be trained and validated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span> <span class="o">=</span> <span class="n">TrainMonitor</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span> <span class="o">=</span> <span class="n">ValidMonitor</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.finish_train_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">finish_train_epoch</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Finishes a training epoch.</p>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">finish_train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finishes a training epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">finish_epoch</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.finish_valid_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">finish_valid_epoch</span><span class="p">(</span><span class="n">valid_flag</span><span class="p">,</span> <span class="n">valid_per_epochs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Finishes a validation epoch.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>valid_flag</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The validation flag.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>valid_per_epochs</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of epochs per validation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The result from the finish_epoch method of the ValidMonitor object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">finish_valid_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">valid_per_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finishes a validation epoch.</span>

<span class="sd">    Args:</span>
<span class="sd">        valid_flag: The validation flag.</span>
<span class="sd">        valid_per_epochs: The number of epochs per validation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The result from the finish_epoch method of the ValidMonitor object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">finish_epoch</span><span class="p">(</span>
        <span class="n">train_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">,</span>
        <span class="n">valid_flag</span><span class="o">=</span><span class="n">valid_flag</span><span class="p">,</span>
        <span class="n">valid_per_epochs</span><span class="o">=</span><span class="n">valid_per_epochs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.load_state_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Loads the state of the TrainMonitor and ValidMonitor from a dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state_dict</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dictionary containing the state of the TrainMonitor and ValidMonitor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the state of the TrainMonitor and ValidMonitor from a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        state_dict:</span>
<span class="sd">            The dictionary containing the state of the TrainMonitor and ValidMonitor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;train_monitor&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;valid_monitor&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.start_train_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_train_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Starts a new training epoch.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The epoch number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">start_train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a new training epoch.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch: The epoch number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.start_valid_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_valid_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Starts a new validation epoch.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The epoch number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">start_valid_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a new validation epoch.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch: The epoch number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.state_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">state_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieves the state of the TrainMonitor and ValidMonitor in dictionary form.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the TrainMonitor and ValidMonitor, typically including model parameters and
other related information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the state of the TrainMonitor and ValidMonitor in dictionary form.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict:</span>
<span class="sd">            The current state of the TrainMonitor and ValidMonitor, typically including model parameters and</span>
<span class="sd">            other related information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">train_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="n">valid_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.train_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_step</span><span class="p">(</span><span class="n">step_num</span><span class="p">,</span> <span class="n">optim_lr</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Executes a training step.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>step_num</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The step number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>optim_lr</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The learning rate(s) of the optimizer(s).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_metrics</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The training metrics.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">step_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">optim_lr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">train_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes a training step.</span>

<span class="sd">    Args:</span>
<span class="sd">        step_num: The step number.</span>
<span class="sd">        optim_lr: The learning rate(s) of the optimizer(s).</span>
<span class="sd">        train_metrics: The training metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
        <span class="n">step_num</span><span class="o">=</span><span class="n">step_num</span><span class="p">,</span> <span class="n">optim_lr</span><span class="o">=</span><span class="n">optim_lr</span><span class="p">,</span> <span class="n">train_metrics</span><span class="o">=</span><span class="n">train_metrics</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.valid_model_snapshot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">valid_model_snapshot</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">sample_index</span><span class="p">,</span> <span class="n">used_sample</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Creates a snapshot of the validation model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The epoch number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>domain</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The domain of validation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_index</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sample index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>used_sample</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sample used for validation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">valid_model_snapshot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">used_sample</span><span class="p">:</span> <span class="n">Dict</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a snapshot of the validation model.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch: The epoch number.</span>
<span class="sd">        domain: The domain of validation.</span>
<span class="sd">        sample_index: The sample index.</span>
<span class="sd">        used_sample: The sample used for validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">model_snapshot</span><span class="p">(</span>
        <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
        <span class="n">sample_index</span><span class="o">=</span><span class="n">sample_index</span><span class="p">,</span>
        <span class="n">used_sample</span><span class="o">=</span><span class="n">used_sample</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.valid_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">valid_step</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Executes a validation step.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>valid_metrics</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The validation metrics.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">valid_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes a validation step.</span>

<span class="sd">    Args:</span>
<span class="sd">        valid_metrics: The validation metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">valid_metrics</span><span class="o">=</span><span class="n">valid_metrics</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.TrainValidMonitor.wait_empty_queues" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wait_empty_queues</span><span class="p">(</span><span class="n">sleep_time</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_wait_round</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Check whether the snapshot creator processes of train_monitor and valid_monitor are still working.
Wait until the material queues of the snapshot creators become empty.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sleep_time</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sleep time in seconds between each check. Default is 10 seconds.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_wait_round</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of waiting rounds. Default is 60 rounds.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">wait_empty_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_wait_round</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether the snapshot creator processes of train_monitor and valid_monitor are still working.</span>
<span class="sd">    Wait until the material queues of the snapshot creators become empty.</span>

<span class="sd">    Args:</span>
<span class="sd">        sleep_time: The sleep time in seconds between each check. Default is 10 seconds.</span>
<span class="sd">        max_wait_round: The maximum number of waiting rounds. Default is 60 rounds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_wait_round</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The training snapshooter is still snapshotting. &quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_monitor</span><span class="o">.</span><span class="n">empty_queue</span><span class="p">():</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The validation snapshooter is still snapshotting. &quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds......&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The maximal waiting time </span><span class="si">{</span><span class="n">max_wait_round</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds is reached, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;so the snapshooters will be shut down......&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="monitor.ValidMonitor" class="doc doc-heading">
            <code>ValidMonitor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="monitor.Monitor" href="#monitor.Monitor">Monitor</a></code></p>


        <p>The ValidMonitor class extends the Monitor class by adding functionality to track validation progress and
performance. It provides methods to initialize monitoring, record metrics at each validation step, and snapshot
the model at each epoch.</p>






              <details class="quote">
                <summary>Source code in <code>speechain/monitor.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ValidMonitor</span><span class="p">(</span><span class="n">Monitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ValidMonitor class extends the Monitor class by adding functionality to track validation progress and</span>
<span class="sd">    performance. It provides methods to initialize monitoring, record metrics at each validation step, and snapshot</span>
<span class="sd">    the model at each epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the validation monitor with the given arguments and the model.</span>
<span class="sd">        This method is responsible for setting up the general members, tracking best models, early stopping, and last models.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (argparse.Namespace):</span>
<span class="sd">                Arguments provided for monitoring.</span>
<span class="sd">            model (Model, optional):</span>
<span class="sd">                The model being validated. This parameter must not be None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If the provided model is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Model must be provided and not None.&quot;</span>
        <span class="c1"># register a pointer of the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="c1"># running mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">no_optim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;valid&quot;</span>

        <span class="c1"># best models-related members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">best_model_selection</span>
        <span class="c1"># receive a single metric as a standalone list or tuple</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">,</span> <span class="n">List</span><span class="p">),</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;best_model_selection must be given as a list, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but got type(best_model_selection)=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">)):</span>
            <span class="c1"># checking the argument types</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span> <span class="p">(</span>
                <span class="s2">&quot;Each element of best_model_selection must be either a list or a tuple, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but got type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Each element of best_model_selection must be a quad-tuple or qual-list, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but got length=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">,</span>
            <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;The best_model_mode must be either &#39;max&#39; or &#39;min&#39;, but got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="c1"># model saving-related members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">])]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># early stopping-related members, the first metric in self.best_model_selection is used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">early_stopping_patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">early_stopping_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">inf</span>
        <span class="p">)</span>

        <span class="c1"># last models-related members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">last_model_number</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;last_model_number cannot be lower than 1, &quot;</span>
                <span class="s2">&quot;otherwise the training will not be able to resume.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got last_model_number=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># initialize the snapshooter of this validation monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visual_snapshot_interval</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">visual_snapshot_interval</span>

    <span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the monitor for a new epoch of validation.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch (int): The current epoch number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># epoch-level information</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The record of epoch no.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> has already existed in the monitor! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;It will be overwritten by the new record obtained shortly thereafter.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># refresh the step-level records at the beginning of each epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_step_records</span><span class="p">()</span>

        <span class="c1"># logging the beginning information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The validation part of epoch no.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> starts.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records information for a single validation step.</span>

<span class="sd">        Args:</span>
<span class="sd">            valid_metrics (Dict[str, torch.Tensor]):</span>
<span class="sd">                The validation metrics for the current step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># accumulate the values of validation criteria</span>
        <span class="k">if</span> <span class="n">valid_metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_step_info</span><span class="p">(</span><span class="s2">&quot;criteria&quot;</span><span class="p">,</span> <span class="n">valid_metrics</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_snapshot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">used_sample</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a snapshot of the model at the given epoch for a given sample.</span>

<span class="sd">        Args:</span>
<span class="sd">            epoch (int):</span>
<span class="sd">                The current epoch number.</span>
<span class="sd">            domain (str):</span>
<span class="sd">                The domain of the current sample.</span>
<span class="sd">            sample_index (str):</span>
<span class="sd">                The index of the current sample.</span>
<span class="sd">            used_sample (Dict):</span>
<span class="sd">                The current sample being used for validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize the sub-dict for each sample</span>
        <span class="k">if</span> <span class="n">sample_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="n">sample_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># get the visualization logs for model snapshotting</span>
        <span class="n">vis_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">batch_data</span><span class="o">=</span><span class="n">used_sample</span><span class="p">,</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">epoch_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">,</span>
            <span class="n">sample_index</span><span class="o">=</span><span class="n">sample_index</span><span class="p">,</span>
            <span class="n">snapshot_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visual_snapshot_interval</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># put all the visualization logs into the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">vis_logs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_better</span><span class="p">(</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares a query value with a target value under a specified mode, optionally considering a threshold.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            query (int, float):</span>
<span class="sd">                The value to be compared against the target.</span>
<span class="sd">            target (int, float):</span>
<span class="sd">                The reference value for the comparison.</span>
<span class="sd">            mode (str):</span>
<span class="sd">                The comparison mode - &#39;max&#39; implies the query is considered better if it&#39;s larger,</span>
<span class="sd">                &#39;min&#39; implies the query is considered better if it&#39;s smaller.</span>
<span class="sd">            threshold (float, optional):</span>
<span class="sd">                A value that adjusts the target value before comparison. Default is 0.0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the query value is considered better than the target, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="c1"># relative threshold if the argument value is positive</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_target</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">threshold</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span>
        <span class="c1"># absolute threshold if the argument value is negative</span>
        <span class="k">elif</span> <span class="n">threshold</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_target</span> <span class="o">+=</span> <span class="o">-</span><span class="n">threshold</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="n">threshold</span>

        <span class="c1"># the threshold is applied to the better comparison</span>
        <span class="k">return</span> <span class="n">query</span> <span class="o">&gt;</span> <span class="n">_target</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="n">query</span> <span class="o">&lt;</span> <span class="n">_target</span>

    <span class="k">def</span> <span class="nf">model_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_records</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts the model into the ensemble if it&#39;s better than the existing models. The model is evaluated using</span>
<span class="sd">        the training records and the validation flag.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            train_records (Dict):</span>
<span class="sd">                A dictionary containing the training records, presumably including model performance metrics.</span>
<span class="sd">            valid_flag (bool):</span>
<span class="sd">                A flag indicating whether the model has passed validation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># loop each metric for best model selection</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;valid&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid_flag</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">_metric_name</span><span class="p">,</span> <span class="n">_metric_mode</span><span class="p">,</span> <span class="n">_model_num</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">_criteria_dict</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">train_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">curr_performance</span> <span class="o">=</span> <span class="n">_criteria_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># controls whether to insert the current model into self.best_model_performance or not</span>
            <span class="n">model_insert_flag</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># if there is no empty positions for the model of the current epoch</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">])</span> <span class="o">==</span> <span class="n">_model_num</span><span class="p">:</span>
                <span class="c1"># as long as the current performance is better than one existing record, it should be inserted.</span>
                <span class="k">for</span> <span class="n">performance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_better</span><span class="p">(</span>
                        <span class="n">query</span><span class="o">=</span><span class="n">curr_performance</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">performance</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_metric_mode</span>
                    <span class="p">):</span>
                        <span class="n">model_insert_flag</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="c1"># True if there are some empty positions for the best models</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_insert_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># record the current model performance</span>
            <span class="k">if</span> <span class="n">model_insert_flag</span><span class="p">:</span>
                <span class="c1"># record the performance of the current epoch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_performance</span>

        <span class="c1"># save the model of the latest epoch onto the disk</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_best_and_pop_worst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the best model in the ensemble and removes the worst model. The best and worst are determined</span>
<span class="sd">        based on the performance metrics. The function also handles logging related to model performance.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            epoch_message (str):</span>
<span class="sd">                A string message related to the current epoch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, bool, Dict[str, bool]]:</span>
<span class="sd">                Returns a tuple containing the updated epoch message, a flag indicating whether early stopping</span>
<span class="sd">                conditions are met, and flags related to model performance metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">whether_remove</span><span class="p">(</span><span class="n">remove_epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># retain the last several models within self.last_model_number</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="n">remove_epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remove_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># access metric_epoch_records from the outer scope</span>
                <span class="k">for</span> <span class="n">_epoch_record</span> <span class="ow">in</span> <span class="n">metric_epoch_records</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">remove_epoch</span> <span class="ow">in</span> <span class="n">_epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">]:</span>
                        <span class="n">remove_flag</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">return</span> <span class="n">remove_flag</span>

        <span class="c1"># --- Gather the epoch record information for each metric --- #</span>
        <span class="n">metric_epoch_records</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># loop each metric for best model selection</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
            <span class="n">_metric_name</span><span class="p">,</span> <span class="n">_metric_mode</span><span class="p">,</span> <span class="n">_model_num</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># find the best epoch and worst epoch in self.best_model_performance</span>
            <span class="n">sorted_epochs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">_metric_mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">metric_epoch_records</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">sorted_epochs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">sorted_epochs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="n">metric_mode</span><span class="o">=</span><span class="n">_metric_mode</span><span class="p">,</span>
                <span class="n">model_num</span><span class="o">=</span><span class="n">_model_num</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># --- Pop out the worst model and Update the model symbol links --- #</span>
        <span class="n">metric_pop_flags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">epoch_record</span> <span class="ow">in</span> <span class="n">metric_epoch_records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># controls whether the worst model has been pooped out or not</span>
            <span class="n">metric_pop_flags</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># pop out the worst model if there is a redundant one in self.best_model_performance</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;model_num&quot;</span><span class="p">]:</span>
                <span class="c1"># pick up the epoch number of the worst model</span>
                <span class="n">worst_epoch</span> <span class="o">=</span> <span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">worst_epoch</span><span class="p">)</span>
                <span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">worst_epoch</span><span class="p">)</span>
                <span class="n">metric_pop_flags</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># update the symbol links of all the best models so far</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">]):</span>
                <span class="n">_best_model_pointer</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best.pth&quot;</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.pth&quot;</span>
                <span class="p">)</span>
                <span class="c1"># create a soft link from the best model pointer to the model fi le of the current epoch</span>
                <span class="n">symlink_dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">_best_model_pointer</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">),</span>
                    <span class="n">symlink_dst</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># update the symbol links of the last several models</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">_last_model_pointer</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;latest.pth&quot;</span>
                <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;last_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.pth&quot;</span>
            <span class="p">)</span>
            <span class="c1"># create a soft link from the best model pointer to the model file of the current epoch</span>
            <span class="n">symlink_dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">_last_model_pointer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">),</span> <span class="n">symlink_dst</span>
            <span class="p">)</span>

        <span class="c1"># remove the redundant model files</span>
        <span class="n">saved_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">saved_epochs</span><span class="p">:</span>
            <span class="n">epoch_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">whether_remove</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
                <span class="c1"># remove the record of epoch in the memory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

                <span class="c1"># remove the model file if it exists</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">epoch_model_path</span><span class="p">):</span>
                    <span class="c1"># ensure that the model to be removed is successfully removed</span>
                    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">epoch_model_path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">epoch_model_path</span><span class="p">)</span>

        <span class="c1"># --- Early-Stopping epoch number checking for the early-stopping metric --- #</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_epoch_records</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="p">][</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">metric_epoch_records</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="p">][</span>
                <span class="s2">&quot;sorted_epochs&quot;</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># refresh to 0 or add 1 depending on the comparison the best one and the second best one</span>
            <span class="k">if</span> <span class="n">best_epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">:</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="si">}</span><span class="s2"> of the current epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is the best so far.</span><span class="se">\n</span><span class="s2">&quot;</span>

                <span class="c1"># compare the current performance and the last best performance</span>
                <span class="n">best_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span>
                <span class="p">][</span><span class="n">best_epoch</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_better</span><span class="p">(</span>
                    <span class="n">best_performance</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_mode</span><span class="p">,</span>
                    <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The early-stopping threshold </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span><span class="si">}</span><span class="s2"> is reached, &quot;</span>
                        <span class="s2">&quot;so the early-stopping epoch number is refreshed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span> <span class="o">=</span> <span class="n">best_performance</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The early-stopping threshold </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span><span class="si">}</span><span class="s2"> is not reached, &quot;</span>
                        <span class="s2">&quot;so the early-stopping epoch number keeps increasing.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># directly add 1 if the current epoch is not the best</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;No improvement of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="si">}</span><span class="s2"> in the current epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># report the updated early-stopping epoch number</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;The early-stopping epoch number has been updated to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># early-stopping check by the patience</span>
        <span class="n">early_stopping_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span>
        <span class="p">):</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The early-stopping patience </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span><span class="si">}</span><span class="s2"> is reached, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;so the training process stops here.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">early_stopping_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;The early-stopping patience is not set by your exp_cfg, &quot;</span>
                <span class="s2">&quot;so the training will continue until num_epochs is reached.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">epoch_message</span><span class="p">,</span> <span class="n">early_stopping_flag</span><span class="p">,</span> <span class="n">metric_pop_flags</span>

    <span class="k">def</span> <span class="nf">save_aver_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_pop_flags</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores the average model in the ensemble and updates the epoch message based on the model performance metrics.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            epoch_message (str):</span>
<span class="sd">                A string message related to the current epoch.</span>
<span class="sd">            metric_pop_flags (Dict[str, bool]):</span>
<span class="sd">                A dictionary containing flags related to model performance metrics.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The updated epoch message.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">save_aver_models</span><span class="p">(</span>
            <span class="n">aver_epoch_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">aver_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">aver_model_name</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">):</span>
            <span class="c1"># no average model is saved if there is only one candidate model</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aver_epoch_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># sum up the parameters of all best models</span>
            <span class="n">avg_model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">aver_epoch_list</span><span class="p">:</span>
                <span class="n">_tgt_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span>
                <span class="p">)</span>
                <span class="c1"># skip if the model doesn&#39;t exist</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_tgt_model_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">_avg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># access self.model_save_path from the outer scope</span>
                <span class="k">if</span> <span class="n">avg_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_avg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_tgt_model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">avg_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_tgt_model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">_avg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">avg_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">avg_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_avg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c1"># if no average model, skip this function and return an empty string</span>
            <span class="k">if</span> <span class="n">avg_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for the parameters whose dtype is int, averaging is not performed</span>
                <span class="c1"># reference: https://github.com/espnet/espnet/blob/5fa6dcc4e649dc66397c629d0030d09ecef36b80/espnet2/main_funcs/average_nbest_models.py#L90</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">avg_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">avg_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;torch.int&quot;</span><span class="p">):</span>
                        <span class="n">avg_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/=</span> <span class="n">aver_num</span>

                <span class="c1"># save the average model</span>
                <span class="n">_aver_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">aver_model_name</span><span class="p">)</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">avg_model</span><span class="p">,</span> <span class="n">_aver_model_path</span><span class="p">)</span>

                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aver_model_name</span><span class="si">}</span><span class="s2"> has been updated to the average of epochs </span><span class="si">{</span><span class="n">aver_epoch_list</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># --- Save the average model for the best models of each metric --- #</span>
        <span class="c1"># loop each metric for best model selection</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
            <span class="n">_metric_name</span><span class="p">,</span> <span class="n">_metric_mode</span><span class="p">,</span> <span class="n">_model_num</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># average the recorded best models so far</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">])</span> <span class="o">==</span> <span class="n">_model_num</span>
                <span class="ow">and</span> <span class="n">metric_pop_flags</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="n">save_aver_models</span><span class="p">(</span>
                    <span class="n">aver_epoch_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">),</span>
                    <span class="n">aver_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]),</span>
                    <span class="n">aver_model_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_model_num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">_metric_name</span><span class="si">}</span><span class="s2">_average.pth&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># --- Save the average model of the last models --- #</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">:</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="n">save_aver_models</span><span class="p">(</span>
                <span class="n">aver_epoch_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">aver_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">,</span>
                <span class="n">aver_model_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="si">}</span><span class="s2">_last_average.pth&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">epoch_message</span>

    <span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">train_records</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">valid_per_epochs</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completes the current epoch by evaluating the model on the training records and potentially performing</span>
<span class="sd">        validation based on the validation flag and number of validation epochs.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            train_records (Dict):</span>
<span class="sd">                A dictionary containing the training records, presumably including model performance metrics.</span>
<span class="sd">            valid_flag (bool):</span>
<span class="sd">                A flag indicating whether the model has passed validation.</span>
<span class="sd">            valid_per_epochs (int):</span>
<span class="sd">                The number of epochs between validations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: A flag indicating whether early stopping conditions are met.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ---- The Information Logging Part ---- #</span>
        <span class="k">if</span> <span class="n">valid_flag</span><span class="p">:</span>
            <span class="c1"># report the overall consuming time of the current validation epoch</span>
            <span class="n">epoch_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The validation part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is finished in &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Summary of all validation steps:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># report the information of the consumed calculation time</span>
            <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_time</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

            <span class="c1"># report the information of the consumed GPU memory</span>
            <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_memory</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="c1"># report the information of all the validation criteria</span>
                <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_criteria</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

            <span class="c1"># ---- The SnapShotting Part ---- #</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># only snapshot the time and memory info in the dry running mode</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;consumed_time&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># skip the model visualization records</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">,</span> <span class="s2">&quot;consumed_memory&quot;</span><span class="p">,</span> <span class="s2">&quot;criteria&quot;</span><span class="p">]:</span>
                    <span class="c1"># snapshot the epoch records so for to a curve figure</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
                        <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">materials</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span>
                            <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;curve&quot;</span><span class="p">,</span>
                            <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                            <span class="n">sep_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">subfolder_names</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                            <span class="n">x_stride</span><span class="o">=</span><span class="n">valid_per_epochs</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># notify the snapshooter process of the new queue elements</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The validation part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is skipped.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># ---- The Model Saving and Early Stopping Part ---- #</span>
        <span class="n">early_stopping_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="c1"># insert the current model into self.best_model_performance if needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_insert</span><span class="p">(</span><span class="n">train_records</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">)</span>

            <span class="c1"># After inserting, deal with the worst model performance so far and check the early-stopping</span>
            <span class="p">(</span>
                <span class="n">epoch_message</span><span class="p">,</span>
                <span class="n">early_stopping_flag</span><span class="p">,</span>
                <span class="n">metric_pop_flags</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_best_and_pop_worst</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

            <span class="c1"># save the average models of the best models so far if needed</span>
            <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_aver_model</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">,</span> <span class="n">metric_pop_flags</span><span class="p">)</span>

        <span class="c1"># log the information of the current validation epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">early_stopping_flag</span>

    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the state of the ensemble in dictionary form.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: The current state of the ensemble, typically including model parameters and other related information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">epoch_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">,</span>
            <span class="n">saved_model_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="p">,</span>
            <span class="n">best_model_performance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">,</span>
            <span class="n">early_stopping_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span><span class="p">,</span>
            <span class="n">last_best_performance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.finish_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">finish_epoch</span><span class="p">(</span><span class="n">train_records</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">,</span> <span class="n">valid_per_epochs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Completes the current epoch by evaluating the model on the training records and potentially performing
validation based on the validation flag and number of validation epochs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_records</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the training records, presumably including model performance metrics.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>valid_flag</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A flag indicating whether the model has passed validation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>valid_per_epochs</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of epochs between validations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A flag indicating whether early stopping conditions are met.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">finish_epoch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">train_records</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">valid_per_epochs</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Completes the current epoch by evaluating the model on the training records and potentially performing</span>
<span class="sd">    validation based on the validation flag and number of validation epochs.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        train_records (Dict):</span>
<span class="sd">            A dictionary containing the training records, presumably including model performance metrics.</span>
<span class="sd">        valid_flag (bool):</span>
<span class="sd">            A flag indicating whether the model has passed validation.</span>
<span class="sd">        valid_per_epochs (int):</span>
<span class="sd">            The number of epochs between validations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: A flag indicating whether early stopping conditions are met.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ---- The Information Logging Part ---- #</span>
    <span class="k">if</span> <span class="n">valid_flag</span><span class="p">:</span>
        <span class="c1"># report the overall consuming time of the current validation epoch</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The validation part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is finished in &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Summary of all validation steps:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># report the information of the consumed calculation time</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_time</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="c1"># report the information of the consumed GPU memory</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_consumed_memory</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="c1"># report the information of all the validation criteria</span>
            <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_criteria</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="c1"># ---- The SnapShotting Part ---- #</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># only snapshot the time and memory info in the dry running mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;consumed_time&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># skip the model visualization records</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;consumed_time&quot;</span><span class="p">,</span> <span class="s2">&quot;consumed_memory&quot;</span><span class="p">,</span> <span class="s2">&quot;criteria&quot;</span><span class="p">]:</span>
                <span class="c1"># snapshot the epoch records so for to a curve figure</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">materials</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span>
                        <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;curve&quot;</span><span class="p">,</span>
                        <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                        <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                        <span class="n">sep_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">subfolder_names</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                        <span class="n">x_stride</span><span class="o">=</span><span class="n">valid_per_epochs</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># notify the snapshooter process of the new queue elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The validation part of epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is skipped.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># ---- The Model Saving and Early Stopping Part ---- #</span>
    <span class="n">early_stopping_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="c1"># insert the current model into self.best_model_performance if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_insert</span><span class="p">(</span><span class="n">train_records</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">)</span>

        <span class="c1"># After inserting, deal with the worst model performance so far and check the early-stopping</span>
        <span class="p">(</span>
            <span class="n">epoch_message</span><span class="p">,</span>
            <span class="n">early_stopping_flag</span><span class="p">,</span>
            <span class="n">metric_pop_flags</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_best_and_pop_worst</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>

        <span class="c1"># save the average models of the best models so far if needed</span>
        <span class="n">epoch_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_aver_model</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">,</span> <span class="n">metric_pop_flags</span><span class="p">)</span>

    <span class="c1"># log the information of the current validation epoch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">early_stopping_flag</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.is_better" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_better</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Compares a query value with a target value under a specified mode, optionally considering a threshold.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code>(int, float)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value to be compared against the target.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target</code>
            </td>
            <td>
                  <code>(int, float)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reference value for the comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The comparison mode - 'max' implies the query is considered better if it's larger,
'min' implies the query is considered better if it's smaller.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A value that adjusts the target value before comparison. Default is 0.0.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the query value is considered better than the target, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">is_better</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares a query value with a target value under a specified mode, optionally considering a threshold.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        query (int, float):</span>
<span class="sd">            The value to be compared against the target.</span>
<span class="sd">        target (int, float):</span>
<span class="sd">            The reference value for the comparison.</span>
<span class="sd">        mode (str):</span>
<span class="sd">            The comparison mode - &#39;max&#39; implies the query is considered better if it&#39;s larger,</span>
<span class="sd">            &#39;min&#39; implies the query is considered better if it&#39;s smaller.</span>
<span class="sd">        threshold (float, optional):</span>
<span class="sd">            A value that adjusts the target value before comparison. Default is 0.0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the query value is considered better than the target, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_target</span> <span class="o">=</span> <span class="n">target</span>
    <span class="c1"># relative threshold if the argument value is positive</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_target</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">threshold</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span>
    <span class="c1"># absolute threshold if the argument value is negative</span>
    <span class="k">elif</span> <span class="n">threshold</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_target</span> <span class="o">+=</span> <span class="o">-</span><span class="n">threshold</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="n">threshold</span>

    <span class="c1"># the threshold is applied to the better comparison</span>
    <span class="k">return</span> <span class="n">query</span> <span class="o">&gt;</span> <span class="n">_target</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="n">query</span> <span class="o">&lt;</span> <span class="n">_target</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.model_insert" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model_insert</span><span class="p">(</span><span class="n">train_records</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Inserts the model into the ensemble if it's better than the existing models. The model is evaluated using
the training records and the validation flag.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_records</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the training records, presumably including model performance metrics.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>valid_flag</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A flag indicating whether the model has passed validation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">model_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_records</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">valid_flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inserts the model into the ensemble if it&#39;s better than the existing models. The model is evaluated using</span>
<span class="sd">    the training records and the validation flag.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        train_records (Dict):</span>
<span class="sd">            A dictionary containing the training records, presumably including model performance metrics.</span>
<span class="sd">        valid_flag (bool):</span>
<span class="sd">            A flag indicating whether the model has passed validation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># loop each metric for best model selection</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;valid&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid_flag</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">_metric_name</span><span class="p">,</span> <span class="n">_metric_mode</span><span class="p">,</span> <span class="n">_model_num</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">_criteria_dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">train_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="s2">&quot;criteria&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">curr_performance</span> <span class="o">=</span> <span class="n">_criteria_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># controls whether to insert the current model into self.best_model_performance or not</span>
        <span class="n">model_insert_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># if there is no empty positions for the model of the current epoch</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">])</span> <span class="o">==</span> <span class="n">_model_num</span><span class="p">:</span>
            <span class="c1"># as long as the current performance is better than one existing record, it should be inserted.</span>
            <span class="k">for</span> <span class="n">performance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_better</span><span class="p">(</span>
                    <span class="n">query</span><span class="o">=</span><span class="n">curr_performance</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">performance</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">_metric_mode</span>
                <span class="p">):</span>
                    <span class="n">model_insert_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="c1"># True if there are some empty positions for the best models</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_insert_flag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># record the current model performance</span>
        <span class="k">if</span> <span class="n">model_insert_flag</span><span class="p">:</span>
            <span class="c1"># record the performance of the current epoch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_performance</span>

    <span class="c1"># save the model of the latest epoch onto the disk</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.model_snapshot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model_snapshot</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">sample_index</span><span class="p">,</span> <span class="n">used_sample</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Takes a snapshot of the model at the given epoch for a given sample.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current epoch number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>domain</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The domain of the current sample.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_index</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the current sample.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>used_sample</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current sample being used for validation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">model_snapshot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">used_sample</span><span class="p">:</span> <span class="n">Dict</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a snapshot of the model at the given epoch for a given sample.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch (int):</span>
<span class="sd">            The current epoch number.</span>
<span class="sd">        domain (str):</span>
<span class="sd">            The domain of the current sample.</span>
<span class="sd">        sample_index (str):</span>
<span class="sd">            The index of the current sample.</span>
<span class="sd">        used_sample (Dict):</span>
<span class="sd">            The current sample being used for validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize the sub-dict for each sample</span>
    <span class="k">if</span> <span class="n">sample_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">[</span><span class="n">sample_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># get the visualization logs for model snapshotting</span>
    <span class="n">vis_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
        <span class="n">batch_data</span><span class="o">=</span><span class="n">used_sample</span><span class="p">,</span>
        <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
        <span class="n">epoch_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">,</span>
        <span class="n">sample_index</span><span class="o">=</span><span class="n">sample_index</span><span class="p">,</span>
        <span class="n">snapshot_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visual_snapshot_interval</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># put all the visualization logs into the queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">vis_logs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.monitor_init" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">monitor_init</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the validation monitor with the given arguments and the model.
This method is responsible for setting up the general members, tracking best models, early stopping, and last models.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="argparse.Namespace">Namespace</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments provided for monitoring.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="speechain.model.abs.Model">Model</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model being validated. This parameter must not be None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>AssertionError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the provided model is None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">monitor_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the validation monitor with the given arguments and the model.</span>
<span class="sd">    This method is responsible for setting up the general members, tracking best models, early stopping, and last models.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (argparse.Namespace):</span>
<span class="sd">            Arguments provided for monitoring.</span>
<span class="sd">        model (Model, optional):</span>
<span class="sd">            The model being validated. This parameter must not be None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If the provided model is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Model must be provided and not None.&quot;</span>
    <span class="c1"># register a pointer of the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="c1"># running mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">no_optim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">no_optim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;valid&quot;</span>

    <span class="c1"># best models-related members</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">best_model_selection</span>
    <span class="c1"># receive a single metric as a standalone list or tuple</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">,</span> <span class="n">List</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;best_model_selection must be given as a list, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but got type(best_model_selection)=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">)):</span>
        <span class="c1"># checking the argument types</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span> <span class="p">(</span>
            <span class="s2">&quot;Each element of best_model_selection must be either a list or a tuple, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but got type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Each element of best_model_selection must be a quad-tuple or qual-list, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but got length=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;min&quot;</span><span class="p">,</span>
        <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;The best_model_mode must be either &#39;max&#39; or &#39;min&#39;, but got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>

    <span class="c1"># model saving-related members</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">])]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># early stopping-related members, the first metric in self.best_model_selection is used</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">early_stopping_patience</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">early_stopping_threshold</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">inf</span>
    <span class="p">)</span>

    <span class="c1"># last models-related members</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">last_model_number</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;last_model_number cannot be lower than 1, &quot;</span>
            <span class="s2">&quot;otherwise the training will not be able to resume.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Got last_model_number=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="p">)</span>

    <span class="c1"># initialize the snapshooter of this validation monitor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">visual_snapshot_interval</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">visual_snapshot_interval</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.save_aver_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_aver_model</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">,</span> <span class="n">metric_pop_flags</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Stores the average model in the ensemble and updates the epoch message based on the model performance metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch_message</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string message related to the current epoch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metric_pop_flags</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, bool]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing flags related to model performance metrics.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated epoch message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_aver_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_pop_flags</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores the average model in the ensemble and updates the epoch message based on the model performance metrics.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        epoch_message (str):</span>
<span class="sd">            A string message related to the current epoch.</span>
<span class="sd">        metric_pop_flags (Dict[str, bool]):</span>
<span class="sd">            A dictionary containing flags related to model performance metrics.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The updated epoch message.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">save_aver_models</span><span class="p">(</span>
        <span class="n">aver_epoch_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">aver_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">aver_model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="c1"># no average model is saved if there is only one candidate model</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aver_epoch_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># sum up the parameters of all best models</span>
        <span class="n">avg_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">aver_epoch_list</span><span class="p">:</span>
            <span class="n">_tgt_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span>
            <span class="p">)</span>
            <span class="c1"># skip if the model doesn&#39;t exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_tgt_model_path</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">_avg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># access self.model_save_path from the outer scope</span>
            <span class="k">if</span> <span class="n">avg_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_avg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_tgt_model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avg_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_tgt_model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_avg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">avg_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">avg_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_avg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># if no average model, skip this function and return an empty string</span>
        <span class="k">if</span> <span class="n">avg_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for the parameters whose dtype is int, averaging is not performed</span>
            <span class="c1"># reference: https://github.com/espnet/espnet/blob/5fa6dcc4e649dc66397c629d0030d09ecef36b80/espnet2/main_funcs/average_nbest_models.py#L90</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">avg_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">avg_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;torch.int&quot;</span><span class="p">):</span>
                    <span class="n">avg_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/=</span> <span class="n">aver_num</span>

            <span class="c1"># save the average model</span>
            <span class="n">_aver_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">aver_model_name</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">avg_model</span><span class="p">,</span> <span class="n">_aver_model_path</span><span class="p">)</span>

            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aver_model_name</span><span class="si">}</span><span class="s2"> has been updated to the average of epochs </span><span class="si">{</span><span class="n">aver_epoch_list</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># --- Save the average model for the best models of each metric --- #</span>
    <span class="c1"># loop each metric for best model selection</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
        <span class="n">_metric_name</span><span class="p">,</span> <span class="n">_metric_mode</span><span class="p">,</span> <span class="n">_model_num</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># average the recorded best models so far</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">])</span> <span class="o">==</span> <span class="n">_model_num</span>
            <span class="ow">and</span> <span class="n">metric_pop_flags</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="n">save_aver_models</span><span class="p">(</span>
                <span class="n">aver_epoch_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">),</span>
                <span class="n">aver_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]),</span>
                <span class="n">aver_model_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_model_num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">_metric_name</span><span class="si">}</span><span class="s2">_average.pth&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># --- Save the average model of the last models --- #</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">:</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="n">save_aver_models</span><span class="p">(</span>
            <span class="n">aver_epoch_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">aver_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">,</span>
            <span class="n">aver_model_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="si">}</span><span class="s2">_last_average.pth&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">epoch_message</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.start_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepares the monitor for a new epoch of validation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current epoch number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the monitor for a new epoch of validation.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch (int): The current epoch number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># epoch-level information</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The record of epoch no.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> has already existed in the monitor! &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;It will be overwritten by the new record obtained shortly thereafter.&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># refresh the step-level records at the beginning of each epoch</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_step_records</span><span class="p">()</span>

    <span class="c1"># logging the beginning information</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The validation part of epoch no.</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> starts.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.state_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">state_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieves the state of the ensemble in dictionary form.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the ensemble, typically including model parameters and other related information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the state of the ensemble in dictionary form.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict: The current state of the ensemble, typically including model parameters and other related information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">epoch_records</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">,</span>
        <span class="n">saved_model_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="p">,</span>
        <span class="n">best_model_performance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">,</span>
        <span class="n">early_stopping_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span><span class="p">,</span>
        <span class="n">last_best_performance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">step</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Records information for a single validation step.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>valid_metrics</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The validation metrics for the current step.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records information for a single validation step.</span>

<span class="sd">    Args:</span>
<span class="sd">        valid_metrics (Dict[str, torch.Tensor]):</span>
<span class="sd">            The validation metrics for the current step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># accumulate the values of validation criteria</span>
    <span class="k">if</span> <span class="n">valid_metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_step_info</span><span class="p">(</span><span class="s2">&quot;criteria&quot;</span><span class="p">,</span> <span class="n">valid_metrics</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="monitor.ValidMonitor.update_best_and_pop_worst" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_best_and_pop_worst</span><span class="p">(</span><span class="n">epoch_message</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Updates the best model in the ensemble and removes the worst model. The best and worst are determined
based on the performance metrics. The function also handles logging related to model performance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>epoch_message</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string message related to the current epoch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[str, bool, Dict[str, bool]]:
Returns a tuple containing the updated epoch message, a flag indicating whether early stopping
conditions are met, and flags related to model performance metrics.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_best_and_pop_worst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the best model in the ensemble and removes the worst model. The best and worst are determined</span>
<span class="sd">    based on the performance metrics. The function also handles logging related to model performance.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        epoch_message (str):</span>
<span class="sd">            A string message related to the current epoch.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[str, bool, Dict[str, bool]]:</span>
<span class="sd">            Returns a tuple containing the updated epoch message, a flag indicating whether early stopping</span>
<span class="sd">            conditions are met, and flags related to model performance metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">whether_remove</span><span class="p">(</span><span class="n">remove_epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># retain the last several models within self.last_model_number</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="n">remove_epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remove_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># access metric_epoch_records from the outer scope</span>
            <span class="k">for</span> <span class="n">_epoch_record</span> <span class="ow">in</span> <span class="n">metric_epoch_records</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">remove_epoch</span> <span class="ow">in</span> <span class="n">_epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">]:</span>
                    <span class="n">remove_flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">remove_flag</span>

    <span class="c1"># --- Gather the epoch record information for each metric --- #</span>
    <span class="n">metric_epoch_records</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># loop each metric for best model selection</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_selection</span><span class="p">:</span>
        <span class="n">_metric_name</span><span class="p">,</span> <span class="n">_metric_mode</span><span class="p">,</span> <span class="n">_model_num</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">metric</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># find the best epoch and worst epoch in self.best_model_performance</span>
        <span class="n">sorted_epochs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">_metric_mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">metric_epoch_records</span><span class="p">[</span><span class="n">_metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">sorted_epochs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">sorted_epochs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">metric_mode</span><span class="o">=</span><span class="n">_metric_mode</span><span class="p">,</span>
            <span class="n">model_num</span><span class="o">=</span><span class="n">_model_num</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># --- Pop out the worst model and Update the model symbol links --- #</span>
    <span class="n">metric_pop_flags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">epoch_record</span> <span class="ow">in</span> <span class="n">metric_epoch_records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># controls whether the worst model has been pooped out or not</span>
        <span class="n">metric_pop_flags</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># pop out the worst model if there is a redundant one in self.best_model_performance</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;model_num&quot;</span><span class="p">]:</span>
            <span class="c1"># pick up the epoch number of the worst model</span>
            <span class="n">worst_epoch</span> <span class="o">=</span> <span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">worst_epoch</span><span class="p">)</span>
            <span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">worst_epoch</span><span class="p">)</span>
            <span class="n">metric_pop_flags</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># update the symbol links of all the best models so far</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">epoch_record</span><span class="p">[</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">]):</span>
            <span class="n">_best_model_pointer</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best.pth&quot;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.pth&quot;</span>
            <span class="p">)</span>
            <span class="c1"># create a soft link from the best model pointer to the model fi le of the current epoch</span>
            <span class="n">symlink_dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">_best_model_pointer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">),</span>
                <span class="n">symlink_dst</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># update the symbol links of the last several models</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_model_number</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">_last_model_pointer</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;latest.pth&quot;</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;last_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.pth&quot;</span>
        <span class="p">)</span>
        <span class="c1"># create a soft link from the best model pointer to the model file of the current epoch</span>
        <span class="n">symlink_dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">_last_model_pointer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">symlink_dst</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">),</span> <span class="n">symlink_dst</span>
        <span class="p">)</span>

    <span class="c1"># remove the redundant model files</span>
    <span class="n">saved_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">saved_epochs</span><span class="p">:</span>
        <span class="n">epoch_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">whether_remove</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
            <span class="c1"># remove the record of epoch in the memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saved_model_epoch</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

            <span class="c1"># remove the model file if it exists</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">epoch_model_path</span><span class="p">):</span>
                <span class="c1"># ensure that the model to be removed is successfully removed</span>
                <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">epoch_model_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">epoch_model_path</span><span class="p">)</span>

    <span class="c1"># --- Early-Stopping epoch number checking for the early-stopping metric --- #</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_epoch_records</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="p">][</span><span class="s2">&quot;sorted_epochs&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">metric_epoch_records</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="p">][</span>
            <span class="s2">&quot;sorted_epochs&quot;</span>
        <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># refresh to 0 or add 1 depending on the comparison the best one and the second best one</span>
        <span class="k">if</span> <span class="n">best_epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">:</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="si">}</span><span class="s2"> of the current epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> is the best so far.</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="c1"># compare the current performance and the last best performance</span>
            <span class="n">best_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_performance</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span>
            <span class="p">][</span><span class="n">best_epoch</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_better</span><span class="p">(</span>
                <span class="n">best_performance</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_mode</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The early-stopping threshold </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span><span class="si">}</span><span class="s2"> is reached, &quot;</span>
                    <span class="s2">&quot;so the early-stopping epoch number is refreshed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_best_performance</span> <span class="o">=</span> <span class="n">best_performance</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The early-stopping threshold </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span><span class="si">}</span><span class="s2"> is not reached, &quot;</span>
                    <span class="s2">&quot;so the early-stopping epoch number keeps increasing.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># directly add 1 if the current epoch is not the best</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;No improvement of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_metric</span><span class="si">}</span><span class="s2"> in the current epoch no.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># report the updated early-stopping epoch number</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;The early-stopping epoch number has been updated to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># early-stopping check by the patience</span>
    <span class="n">early_stopping_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span>
    <span class="p">):</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The early-stopping patience </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span><span class="si">}</span><span class="s2"> is reached, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;so the training process stops here.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">early_stopping_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_patience</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">epoch_message</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;The early-stopping patience is not set by your exp_cfg, &quot;</span>
            <span class="s2">&quot;so the training will continue until num_epochs is reached.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">epoch_message</span><span class="p">,</span> <span class="n">early_stopping_flag</span><span class="p">,</span> <span class="n">metric_pop_flags</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="monitor.data_saving_logs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">data_saving_logs</span><span class="p">(</span><span class="n">proc_id</span><span class="p">,</span> <span class="n">logs_queue</span><span class="p">,</span> <span class="n">wait_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Continuously monitors a queue for log data to save. If logs are available,
they are retrieved from the queue and saved in the appropriate format.
If the queue is empty, the function pauses for a specified wait time before checking again.
In case of any exceptions during this process, a warning is issued and the function continues.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>proc_id</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The identifier of the current process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>logs_queue</code>
            </td>
            <td>
                  <code><span title="multiprocessing.Queue">Queue</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The queue containing log data to be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wait_time</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of seconds to wait before checking the queue again if it is empty. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>speechain/monitor.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">data_saving_logs</span><span class="p">(</span><span class="n">proc_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">logs_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Continuously monitors a queue for log data to save. If logs are available,</span>
<span class="sd">    they are retrieved from the queue and saved in the appropriate format.</span>
<span class="sd">    If the queue is empty, the function pauses for a specified wait time before checking again.</span>
<span class="sd">    In case of any exceptions during this process, a warning is issued and the function continues.</span>

<span class="sd">    Args:</span>
<span class="sd">        proc_id (int):</span>
<span class="sd">            The identifier of the current process.</span>
<span class="sd">        logs_queue (Queue):</span>
<span class="sd">            The queue containing log data to be saved.</span>
<span class="sd">        wait_time (int, optional):</span>
<span class="sd">            The number of seconds to wait before checking the queue again if it is empty. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Continually check if the logs_queue has items to be saved</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">logs_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">log</span> <span class="o">=</span> <span class="n">logs_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">save_data_by_format</span><span class="p">(</span><span class="o">**</span><span class="n">log</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the queue is empty, pause for a specified wait time</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">proc_id</span><span class="si">}</span><span class="s2"> encountered an exception in data_saving_logs(): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Continuing operation.&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>